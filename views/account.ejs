<%- include('./partials/head', { pageTitle: 'Your Account • BookLantern' }) %>
<body>
  <%- include('./partials/navbar') %>

  <main class="stack" style="--gap:20px; max-width:880px; margin:40px auto; padding:0 16px;">
    <h1>Your Account</h1>

    <!-- Server-side render (if you later attach sessions) -->
    <% if (user) { %>
      <div class="card stack" style="--gap:12px; padding:16px;">
        <div><strong>Name:</strong> <%= user.name || user.user_metadata?.name || '' %></div>
        <div><strong>Email:</strong> <%= user.email %></div>
        <div><strong>Role:</strong> <%= user.role || user.app_metadata?.role || 'reader' %></div>
      </div>
    <% } %>

    <!-- Client-side hydrate via Supabase (works today even without server sessions) -->
    <div id="accountClient" class="card stack" style="--gap:12px; padding:16px; display:none;">
      <div><strong>Name:</strong> <span id="acc-name">—</span></div>
      <div><strong>Email:</strong> <span id="acc-email">—</span></div>
      <div><strong>Role:</strong> <span id="acc-role">reader</span></div>

      <div class="row" style="gap:8px; flex-wrap:wrap; margin-top:8px;">
        <a class="btn" href="/read">Go to Library</a>
        <button id="acc-signout" class="btn" type="button">Sign out</button>
      </div>
    </div>

    <div id="accountEmpty" class="card" style="padding:16px; display:none;">
      You’re not signed in. <a href="/login">Log in</a> to view your account.
    </div>
  </main>

  <%- include('./partials/footer') %>

  <script>
  (async function () {
    const sb = window.supabaseClient;
    try {
      const { data, error } = await sb.auth.getUser();
      if (error) throw error;

      const user = data && data.user;
      const hasServerUser = <%= !!user %>; // whether server rendered user existed

      if (user) {
        // Show client card
        var card = document.getElementById('accountClient');
        card.style.display = 'block';

        var name = user.user_metadata && (user.user_metadata.name || user.user_metadata.full_name) || '';
        document.getElementById('acc-name').textContent = name || '—';
        document.getElementById('acc-email').textContent = user.email || '—';

        var role = (user.app_metadata && user.app_metadata.role) || 'reader';
        document.getElementById('acc-role').textContent = role;

        document.getElementById('acc-signout').addEventListener('click', async function(){
          try {
            await sb.auth.signOut();
          } catch (e) {}
          // Send them to home after signout
          location.href = '/';
        });
      } else {
        // Not logged in
        document.getElementById('accountEmpty').style.display = 'block';
      }
    } catch (e) {
      console.warn('Account load failed:', e);
      document.getElementById('accountEmpty').style.display = 'block';
    }
  })();
  </script>
</body>
</html>
