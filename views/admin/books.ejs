<!doctype html>
<html lang="en">
<head>
  <%- include('../partials/head', {
    pageTitle: 'Admin — Books',
    pageDescription: 'Curate homepage shelves from Supabase.',
    canonicalUrl: (typeof canonicalUrl !== 'undefined' ? canonicalUrl : '')
  }) %>
</head>
<body>
  <%- include('../partials/navbar') %>

  <main class="container" style="padding:24px 0;">
    <a href="/admin" class="btn btn-ghost" style="margin-bottom:16px;">← Back to Admin</a>
    <h1>Books</h1>

    <% if (messages && messages.success) { %>
      <div class="alert success"><%= messages.success %></div>
    <% } %>
    <% if (messages && messages.error) { %>
      <div class="alert danger"><%= messages.error %></div>
    <% } %>

    <div class="grid-2">
      <!-- Add new -->
      <section class="card" style="padding:16px;">
        <h2 style="margin-top:0;">Add New Book</h2>
        <form action="/admin/books" method="post" autocomplete="off">
          <input type="hidden" name="_csrf" value="<%= csrfToken || '' %>" />

          <label>Title</label>
          <input name="title" type="text" required placeholder="Book title" />

          <label>Category</label>
          <select name="category" required>
            <% (Array.isArray(categories) ? categories : ['trending','philosophy','history','science']).forEach(function(c){ %>
              <option value="<%= c %>"><%= c.charAt(0).toUpperCase() + c.slice(1) %></option>
            <% }) %>
          </select>

          <div class="grid-2">
            <div>
              <label>Author (optional)</label>
              <input name="author" type="text" placeholder="Author" />
            </div>
            <div>
              <label>Cover URL (optional)</label>
              <input name="cover_image" type="url" placeholder="https://…" />
            </div>
          </div>

          <label>Source URL</label>
          <input name="source_url" type="url" placeholder="https://archive.org/details/…" />

          <label>Short description (optional)</label>
          <textarea name="description" rows="4" placeholder="Short note you want to show with the card (optional)"></textarea>

          <button class="btn" type="submit" style="margin-top:12px;">Add Book</button>
          <p class="muted" style="margin-top:12px;">
            Tip: If the source is an Internet Archive identifier (e.g., <code>https://archive.org/details/…</code>),
            our reader can open it internally.
          </p>
        </form>
      </section>

      <!-- Existing -->
      <section class="card" style="padding:16px;">
        <h2 style="margin-top:0;">Existing Books</h2>
        <% const LIST = Array.isArray(books) ? books : []; %>
        <% if (!LIST.length) { %>
          <div class="muted">No curated books yet.</div>
        <% } else { %>
          <ul class="list">
            <% LIST.forEach(function(b){ %>
              <li class="list-row">
                <div class="row-main">
                  <div class="thumb" style="width:52px;height:72px;background:#eef1f5;display:flex;align-items:center;justify-content:center;border-radius:8px;overflow:hidden;margin-right:12px;">
                    <% if (b.cover_image) { %>
                      <img src="<%= b.cover_image %>" alt="" style="width:100%;height:100%;object-fit:cover;" />
                    <% } else { %>
                      <span class="muted">No cover</span>
                    <% } %>
                  </div>
                  <div>
                    <strong><%= b.title %></strong>
                    <% if (b.category) { %>
                      <span class="badge"><%= b.category.charAt(0).toUpperCase() + b.category.slice(1) %></span>
                    <% } %>
                    <% if (b.source_url) { %>
                      <a href="<%= b.source_url %>" target="_blank" rel="noopener" class="muted" style="margin-left:6px;">Source</a>
                    <% } %>
                    <div class="muted">
                      Added <%= (b.created_at ? new Date(b.created_at).toLocaleDateString() : '—') %>
                      <% if (b.author) { %> · <em><%= b.author %></em> <% } %>
                    </div>
                  </div>
                </div>
                <form action="/admin/books/delete" method="post" class="row-actions">
                  <input type="hidden" name="_csrf" value="<%= csrfToken || '' %>" />
                  <input type="hidden" name="id" value="<%= b.id %>" />
                  <button class="btn btn-danger" type="submit">Delete</button>
                </form>
              </li>
            <% }) %>
          </ul>
        <% } %>
      </section>
    </div>
  </main>

  <style>
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    @media (max-width: 900px){ .grid-2 { grid-template-columns: 1fr; } }

    .list { list-style:none; padding:0; margin:0; }
    .list-row {
      display:flex; align-items:center; justify-content:space-between;
      padding:12px; border:1px solid #eee; border-radius:12px; margin-bottom:10px; background:#fff;
    }
    .row-main { display:flex; align-items:center; }
    .row-actions { margin-left:12px; }
    .badge { background:#eef1f5; color:#334; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:6px; }
    .muted { color:#667; }
    .alert { padding:10px 12px; border-radius:10px; margin-bottom:12px; }
    .alert.success { background:#e8f7ef; color:#265f3a; }
    .alert.danger { background:#fdeaea; color:#7a2020; }
  </style>

  <%- include('../partials/footer') %>
</body>
</html>
