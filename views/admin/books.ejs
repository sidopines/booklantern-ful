<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../partials/head'); %>
  <title>Admin • Books</title>
  <style>
    .admin-wrap{max-width:980px;margin:24px auto 64px;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{border:1px solid #eee;border-radius:12px;padding:16px;background:#fff}
    .muted{color:#666;font-size:14px}
    .tbl{width:100%;border-collapse:collapse;margin-top:12px}
    .tbl th,.tbl td{border-bottom:1px solid #eee;padding:8px 6px;text-align:left}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .row .grow{flex:1}
    .input, textarea, select{width:100%}
    .btn{display:inline-block;border:1px solid #ddd;border-radius:8px;padding:8px 12px;background:#fafafa;cursor:pointer}
    .btn.danger{border-color:#f3d2d2;background:#fff3f3;color:#a00}
    .btn.primary{background:#111;color:#fff;border-color:#111}
    .btn.link{background:transparent;border-color:#ddd}
    .select, .input{border:1px solid #ddd;border-radius:8px;padding:8px 10px}
    .note{background:#fff9e6;border:1px solid #ffe7a3;padding:8px 10px;border-radius:8px}
    .note.ok{background:#f0fdf4;border-color:#bbf7d0;color:#065f46}
    .note.err{background:#fff1f2;border-color:#fecaca;color:#9f1239}
    .note.deleted{background:#fef2f2;border-color:#fecaca;color:#7f1d1d}
    .note.updated{background:#ecfeff;border-color:#a5f3fc;color:#164e63}
  </style>
</head>
<body>
  <%- include('../partials/header'); %>

  <main class="admin-wrap">
    <h1>Admin • Books</h1>

    <% if (messages && messages.error) { %>
      <p class="note err"><%= messages.error %></p>
    <% } %>
    <% if (messages && messages.success) { %>
      <p class="note ok"><%= messages.success %></p>
    <% } %>
    <% if (messages && messages.deleted) { %>
      <p class="note deleted"><%= messages.deleted %></p>
    <% } %>
    <% if (messages && messages.updated) { %>
      <p class="note updated"><%= messages.updated %></p>
    <% } %>

    <div class="grid">
      <!-- Create -->
      <section class="card">
        <h2 style="margin-top:0;">Add a book</h2>
        <form method="POST" action="/admin/books" enctype="application/x-www-form-urlencoded">
          <div class="row">
            <label class="grow">Title
              <input class="input" type="text" name="title" required>
            </label>
          </div>

          <div class="row">
            <label class="grow">Author
              <input class="input" type="text" name="author">
            </label>
          </div>

          <div class="row">
            <label class="grow">Genre / Shelf
              <select class="select" name="category" required>
                <% if (typeof shelves !== 'undefined' && shelves.length) { %>
                  <option value="">Select a shelf…</option>
                  <% shelves.forEach(s => { %>
                    <option value="<%= s.value %>"><%= s.label %></option>
                  <% }) %>
                <% } else { %>
                  <option disabled selected>No shelves configured</option>
                <% } %>
              </select>
            </label>
          </div>

          <div class="row">
            <label class="grow">Cover URL
              <input class="input" type="url" name="cover" placeholder="https://…/cover.jpg">
            </label>
          </div>

          <div class="row">
            <label class="grow">Source URL (preferred)
              <input class="input" type="url" name="source_url" placeholder="https://…">
              <small style="color:#666;font-size:13px;display:block;margin-top:4px;">
                Option A: paste full book page URL here. Option B: choose a Provider and enter its ID below.
              </small>
            </label>
          </div>

          <div class="row">
            <label class="grow">OR Provider (e.g. gutenberg)
              <input class="input" type="text" name="provider" placeholder="gutenberg, openlibrary, archive, loc">
            </label>
            <label class="grow">Provider ID
              <input class="input" type="text" name="provider_id" placeholder="1342">
            </label>
          </div>

          <div class="row">
            <button class="btn primary" type="submit">Save</button>
          </div>
        </form>
      </section>

      <!-- Help -->
      <aside class="card">
        <h2 style="margin-top:0;">How this works</h2>
        <p class="muted">
          This page posts to <code>POST /admin/books</code> and lists below from <code>curated_books</code>.
          Pick a <strong>Genre / Shelf</strong> to place the book on the correct homepage row.
        </p>
      </aside>
    </div>

    <section class="card" style="margin-top:16px;">
      <h2 style="margin-top:0;">Books</h2>
      <%
        const LIST = Array.isArray(books) ? books : [];
        if (!LIST.length) { %>
        <p class="muted">No books yet.</p>
      <% } else { %>
        <table class="tbl">
          <thead>
            <tr>
              <th style="width:38%;">Title</th>
              <th style="width:24%;">Author</th>
              <th style="width:20%;">Genre</th>
              <th style="width:18%;">Actions</th>
            </tr>
          </thead>
          <tbody>
          <% LIST.forEach(function(b){ %>
            <tr>
              <td><%- b.title %></td>
              <td><%- b.author || '' %></td>
              <td><%- b.category || '' %></td>
              <td>
                <a class="btn link" href="/admin/books/<%- b.id %>">Edit</a>
                <form method="POST" action="/admin/books/delete" style="display:inline;">
                  <input type="hidden" name="id" value="<%- b.id %>">
                  <button class="btn danger" type="submit" onclick="return confirm('Delete “<%- (b.title || '').replace(/\"/g, '&quot;') %>”? This cannot be undone.');">Delete</button>
                </form>
              </td>
            </tr>
          <% }) %>
          </tbody>
        </table>
      <% } %>
    </section>
  </main>

  <%- include('../partials/footer'); %>
</body>
</html>
