<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../partials/head.ejs', {
    pageTitle: typeof pageTitle !== 'undefined' ? pageTitle : 'Admin • Users',
    pageDescription: typeof pageDescription !== 'undefined' ? pageDescription : 'Manage users'
  }) %>
  <style>
    :root { --bg:#f6f7fb; --text:#111; --muted:#667085; --card:#ffffff; --border:#e5e7eb; --link:#1256b3; --brand:#111; --brandHover:#333; --danger:#b42318; --ok:#0f766e;}
    * { box-sizing: border-box; }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    main { max-width: 1100px; margin: 2rem auto 3rem; padding: 0 1rem; }
    .crumbs { display:flex; align-items:center; gap:.5rem; margin-bottom: 1rem; }
    .crumbs a { color: var(--link); text-decoration: none; font-size: .95rem; }
    .crumbs a:hover { text-decoration: underline; }
    h1 { margin: 0 0 1rem 0; font-size: clamp(1.6rem, 2.5vw, 2rem); }

    .bar { display:flex; gap:12px; align-items:center; justify-content: space-between; flex-wrap: wrap; margin-bottom: 12px; }
    .search { display:flex; gap:8px; align-items:center; }
    .search input[type="text"]{
      padding: .6rem .7rem; border:1px solid var(--border); border-radius: 10px; min-width: 260px; background:#fff;
    }
    .btn { padding:.6rem 1rem; border:1px solid var(--border); border-radius:10px; background:var(--brand); color:#fff; font-weight:600; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; gap:6px;}
    .btn:hover{ background: var(--brandHover); }
    .btn.outline{ background:#fff; color:var(--text); }
    .btn.danger{ background:var(--danger); border-color:#fca5a5; }
    .btn.small{ padding:.45rem .7rem; border-radius:8px; font-size:.9rem; }

    .notice { margin: 10px 0; padding: 10px 12px; border-radius: 10px; font-size: .95rem; }
    .notice.ok { background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; }
    .notice.err { background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }

    .card { background:#fff; border:1px solid var(--border); border-radius:14px; box-shadow:0 8px 28px rgba(0,0,0,.06); overflow:hidden; }
    .table { width:100%; border-collapse: collapse; }
    .table th, .table td { text-align:left; padding:12px 10px; border-bottom:1px solid var(--border); font-size: .95rem; }
    .table th { background:#fafafa; color:#475569; font-weight:700; }
    .table tr:last-child td { border-bottom:0; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:.9rem; color:#475569; }
    .badges{ display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:.8rem; border:1px solid var(--border); background:#fff; color:#334155; }
    .badge.green { background:#ecfdf5; border-color:#a7f3d0; color:#065f46; }
    .badge.yellow { background:#fefce8; border-color:#fde68a; color:#92400e; }
    .row-actions { display:flex; gap:6px; flex-wrap:wrap; }
    .right { text-align:right; }
    @media (max-width: 920px){
      .hide-sm { display:none; }
      .search input[type="text"]{ min-width: 170px; }
    }
  </style>
</head>
<body>
  <%- include('../partials/navbar.ejs') %>

  <main>
    <div class="crumbs">
      <a href="/admin">← Admin</a>
      <span style="color:#94a3b8">/</span>
      <span>Users</span>
    </div>

    <h1>Users</h1>

    <% if (ok) { %><div class="notice ok">✅ Saved.</div><% } %>
    <% if (err) { %><div class="notice err">⚠️ <%= err %></div><% } %>

    <div class="bar">
      <form class="search" method="GET" action="/admin/users">
        <input type="text" name="q" value="<%= q || '' %>" placeholder="Search by name or email…" />
        <button class="btn outline" type="submit">Search</button>
        <% if (q) { %><a class="btn outline" href="/admin/users">Clear</a><% } %>
      </form>
      <div class="badges">
        <span class="badge"><strong><%= users.length %></strong> shown</span>
      </div>
    </div>

    <section class="card">
      <table class="table">
        <thead>
          <tr>
            <th>Name / Email</th>
            <th class="hide-sm">Status</th>
            <th class="hide-sm">Created</th>
            <th class="right">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% if (!users || users.length === 0) { %>
            <tr><td colspan="4" style="color:#667085; padding:24px;">No users found.</td></tr>
          <% } else { %>
            <% users.forEach(function(u){ 
                 const isSelf = String(user && user._id) === String(u._id);
            %>
              <tr>
                <td>
                  <div style="font-weight:700;"><%= u.name %></div>
                  <div class="mono"><%= u.email %></div>
                </td>
                <td class="hide-sm">
                  <div class="badges">
                    <% if (u.isVerified) { %><span class="badge green">Verified</span><% } else { %><span class="badge">Unverified</span><% } %>
                    <% if (u.isAdmin) { %><span class="badge yellow">Admin</span><% } %>
                  </div>
                </td>
                <td class="hide-sm">
                  <span class="mono"><%= new Date(u.createdAt).toLocaleString() %></span>
                </td>
                <td class="right">
                  <div class="row-actions">
                    <% if (!isSelf) { %>
                      <form action="/admin/users/<%= u._id %>/admin" method="POST" onsubmit="return confirm('Toggle admin for <%= u.email %>?')">
                        <button class="btn small" type="submit"><%= u.isAdmin ? 'Revoke admin' : 'Make admin' %></button>
                      </form>
                      <form action="/admin/users/<%= u._id %>/delete" method="POST" onsubmit="return confirm('Delete user <%= u.email %>? This cannot be undone.')">
                        <button class="btn small danger" type="submit">Delete</button>
                      </form>
                    <% } else { %>
                      <span class="badge">This is you</span>
                    <% } %>
                  </div>
                </td>
              </tr>
            <% }) %>
          <% } %>
        </tbody>
      </table>
    </section>

    <div style="margin-top: 16px;">
      <a href="/admin" class="btn outline">← Back to Admin</a>
    </div>
  </main>
</body>
</html>
