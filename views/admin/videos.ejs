<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../partials/header'); %>
  <title>Admin · Videos</title>
  <style>
    :root { --gap: 14px; }
    .wrap { max-width: 1100px; margin: 24px auto 64px; padding: 0 16px; }
    .row { display: grid; grid-template-columns: 1fr 340px; gap: var(--gap); align-items: start; }
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; }
    h1 { font-size: 28px; margin: 0 0 6px; }
    h2 { font-size: 18px; margin: 0 0 10px; }
    label { display:block; font-weight:600; margin: 12px 0 6px; }
    .muted { color:#667085; font-size: 14px; }
    input[type="text"], input[type="url"], textarea, select {
      width: 100%; padding: 10px 12px; border:1px solid #e5e7eb; border-radius: 10px; font-size: 15px;
    }
    input[type="search"] { width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius: 10px; }
    .btn { display:inline-block; padding:10px 14px; border-radius:10px; border:1px solid #111; background:#111; color:#fff; text-decoration:none; }
    .btn.secondary { background:#fff; color:#111; }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    .genre-box { display:flex; flex-direction:column; gap:8px; }
    .genre-select { min-height: 180px; }
    .thumb-box { border-radius: 10px; overflow: hidden; background:#f6f7f9; aspect-ratio: 16/9;
                 display:flex; align-items:center; justify-content:center; }
    .thumb-box img { width:100%; height:100%; object-fit:cover; display:block; }
    .table { width:100%; border-collapse: collapse; }
    .table th, .table td { padding:10px 8px; border-bottom:1px solid #eee; font-size: 14px; vertical-align: top; }
    .actions { display:flex; gap:8px; }
    .flash { padding:10px 12px; border-radius:10px; margin: 0 0 12px; }
    .flash.ok { background:#ecfdf5; border:1px solid #34d399; color:#065f46; }
    .flash.err { background:#fef2f2; border:1px solid #fca5a5; color:#7f1d1d; }
    @media (max-width: 960px) { .row { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <%- include('../partials/navbar'); %>

  <main class="wrap">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <h1>Manage Videos</h1>
      <div class="muted"><a href="/admin" class="btn secondary">← Back to Admin</a></div>
    </div>

    <% if (messages && messages.success) { %>
      <div class="flash ok">✔ <%= messages.success %></div>
    <% } %>
    <% if (messages && messages.error) { %>
      <div class="flash err">⚠ <%= messages.error %></div>
    <% } %>

    <div class="row">
      <!-- Left: Form -->
      <section class="card">
        <h2>Add / Edit Video</h2>
        <p class="muted">Paste a YouTube link; we’ll auto-generate the thumbnail if you leave it blank.</p>

        <form method="POST" action="/admin/videos" autocomplete="off" id="videoForm">
          <% if (csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>

          <label for="title">Title</label>
          <input id="title" name="title" type="text" placeholder="Great talk on books" required>

          <div class="grid-2">
            <div>
              <label for="url">Video URL</label>
              <input id="url" name="url" type="url" placeholder="https://www.youtube.com/watch?v=…" required>
              <p class="muted">Supports youtube.com/watch, youtu.be, shorts, and embed links.</p>
            </div>

            <div>
              <label for="channel">Channel / Source (optional)</label>
              <input id="channel" name="channel" type="text" placeholder="Channel or source">
            </div>
          </div>

          <div class="grid-2">
            <div>
              <label>Thumbnail</label>
              <div class="thumb-box" id="thumbBox">
                <img id="thumbImg" alt="Thumbnail preview" src="/public/img/cover-fallback.svg">
              </div>
              <input id="thumbnail" name="thumbnail" type="url" placeholder="Custom thumbnail URL (optional)">
              <p class="muted">Leave empty to auto-use the YouTube thumbnail.</p>
            </div>

            <div>
              <label>Genres</label>
              <div class="genre-box">
                <input type="search" id="genreSearch" placeholder="Type to filter genres…">
                <select id="genres" name="genres" class="genre-select" multiple size="10" title="Hold Cmd/Ctrl to multi-select">
                  <% (Array.isArray(genres) ? genres : []).forEach(function(g){ %>
                    <option value="<%= g.id %>"><%= g.name %></option>
                  <% }) %>
                </select>
                <div class="muted">Hold Cmd/Ctrl (Mac/Win) to select multiple.</div>
              </div>
              <label for="newGenres" style="margin-top:12px;">Add new genres (comma-separated)</label>
              <input id="newGenres" name="newGenres" type="text" placeholder="History, Peace, Finance">
              <p class="muted">These will be created and auto-linked to the video.</p>
            </div>
          </div>

          <div style="margin-top:16px;">
            <button class="btn" type="submit">Add Video</button>
          </div>
        </form>
      </section>

      <!-- Right: Help -->
      <aside class="card">
        <h2>Tips</h2>
        <ul class="muted" style="margin:0 0 0 18px; padding:0; list-style: disc;">
          <li>Use <strong>/admin/genres</strong> to maintain the genre list.</li>
          <li>On the public site, cards link to an on-site player at <code>/video/:id</code>.</li>
          <li>Auto thumbnail logic kicks in when <em>Thumbnail</em> is left blank.</li>
        </ul>
      </aside>
    </div>

    <!-- Current videos -->
    <section class="card" style="margin-top: var(--gap);">
      <h2>Current Videos</h2>
      <% const vids = Array.isArray(videos) ? videos : []; %>
      <% if (!vids.length) { %>
        <p class="muted">No videos yet.</p>
      <% } else { %>
        <div style="overflow:auto;">
          <table class="table">
            <thead>
              <tr>
                <th style="width:36%;">Title</th>
                <th>URL</th>
                <th>Channel</th>
                <th style="width:140px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% vids.forEach(function(v){ %>
                <tr>
                  <td><a href="/video/<%= v.id %>" target="_blank" rel="noopener"><%= v.title %></a></td>
                  <td style="word-break:break-all;"><a href="<%= v.url %>" target="_blank" rel="noopener"><%= v.url %></a></td>
                  <td><%= v.channel || '' %></td>
                  <td>
                    <div class="actions">
                      <a class="btn secondary" href="/video/<%= v.id %>" target="_blank" rel="noopener">View</a>
                      <form method="POST" action="/admin/videos/delete" onsubmit="return confirm('Delete this video?');">
                        <% if (csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
                        <input type="hidden" name="id" value="<%= v.id %>">
                        <button class="btn" type="submit" style="background:#b91c1c;border-color:#b91c1c;">Delete</button>
                      </form>
                    </div>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } %>
    </section>
  </main>

  <%- include('../partials/footer'); %>

  <script>
    // --- YouTube helpers ---
    function parseYouTube(url) {
      try {
        const u = new URL(url);
        let id = '';
        if (u.hostname === 'youtu.be') {
          id = u.pathname.replace(/^\\/+/, '');
        } else if (u.hostname.includes('youtube.com')) {
          if (u.searchParams.get('v')) id = u.searchParams.get('v');
          const m = u.pathname.match(/\\/(embed|shorts)\\/([^/?#]+)/);
          if (!id && m) id = m[2];
        }
        if (!id) return null;
        return {
          id,
          thumb: `https://img.youtube.com/vi/${id}/hqdefault.jpg`
        };
      } catch { return null; }
    }

    // Live thumbnail preview
    (function(){
      const url = document.getElementById('url');
      const thumbInput = document.getElementById('thumbnail');
      const img = document.getElementById('thumbImg');

      function updateThumb() {
        const manual = thumbInput.value.trim();
        if (manual) { img.src = manual; return; }
        const yt = parseYouTube(url.value.trim());
        img.src = yt?.thumb || '/public/img/cover-fallback.svg';
      }

      url.addEventListener('input', updateThumb);
      thumbInput.addEventListener('input', updateThumb);
      updateThumb();
    })();

    // Searchable genres
    (function(){
      const search = document.getElementById('genreSearch');
      const select = document.getElementById('genres');
      const all = Array.from(select.options).map(o => ({ value:o.value, text:o.text, option:o }));

      function filter() {
        const q = search.value.trim().toLowerCase();
        all.forEach(({option, text}) => {
          const match = !q || text.toLowerCase().includes(q);
          option.hidden = !match;
        });
      }
      search.addEventListener('input', filter);
    })();

    // Ensure multi-select name submits an array (Express handles both)
    document.getElementById('genres').setAttribute('name', 'genres');
  </script>
</body>
</html>
