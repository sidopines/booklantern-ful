<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('partials/head', { 
    pageTitle: 'Authenticating… • BookLantern',
    pageDescription: 'Completing your sign-in',
    disableMetaRefresh: true 
  }) %>
  <meta name="robots" content="noindex">
</head>
<body>
  <main class="container" style="max-width:760px;margin:60px auto;padding:0 20px;">
    <h1>Authenticating…</h1>
    <pre id="log" style="background:#111;color:#0f0;padding:12px;border-radius:8px;white-space:pre-wrap;min-height:160px;font-family:monospace;font-size:13px;"></pre>
  </main>
  <script>
    (function(){
      const L = (m) => { 
        console.log('[auth-callback]', m); 
        const p = document.createElement('div'); 
        p.textContent = new Date().toISOString().split('T')[1].slice(0,12) + ' ' + m;
        document.getElementById('log').appendChild(p);
      };
      L('href=' + location.href);

      // Boot supabase
      if (!window.supabaseClient) { 
        L('ERROR: supabaseClient not loaded'); 
        L('Check that partials/head includes Supabase SDK');
        return; 
      }

      const sb = window.supabaseClient;
      L('✓ Supabase client ready');

      // Accept BOTH forms:
      // (A) Magic link:   #access_token=...&refresh_token=...
      // (B) OAuth PKCE:   ?code=... (&state=...)
      const hash = new URLSearchParams(location.hash.slice(1));
      const qs   = new URLSearchParams(location.search);

      const at = hash.get('access_token');
      const rt = hash.get('refresh_token');
      const code = qs.get('code');

      L('Tokens in hash: ' + (at ? 'YES (access_token present)' : 'NO'));
      L('OAuth code in query: ' + (code ? 'YES' : 'NO'));

      (async () => {
        try {
          if (at && rt) {
            L('→ Detected magic-link tokens; calling setSession()');
            const { data, error } = await sb.auth.setSession({ access_token: at, refresh_token: rt });
            if (error) { 
              L('✗ ERROR setSession: ' + error.message); 
              return; 
            }
            L('✓ setSession OK, user=' + (data?.user?.email || 'unknown'));
            L('→ Cleaning URL and redirecting to /');
            // Clean the URL then go home
            history.replaceState({}, '', '/');
            setTimeout(() => location.assign('/'), 100);
          } else if (code) {
            L('→ Detected OAuth code; calling exchangeCodeForSession()');
            const { data, error } = await sb.auth.exchangeCodeForSession(code);
            if (error) { 
              L('✗ ERROR exchangeCodeForSession: ' + error.message); 
              return; 
            }
            L('✓ exchangeCodeForSession OK, user=' + (data?.user?.email || 'unknown'));
            L('→ Cleaning URL and redirecting to /');
            history.replaceState({}, '', '/');
            setTimeout(() => location.assign('/'), 100);
          } else {
            L('⚠ No tokens in hash and no code param. Nothing to process.');
            L('If you came from a magic link, verify redirect_to points to /auth/callback.');
            L('You can close this tab or go to <a href="/" style="color:#0f0">homepage</a>');
          }
        } catch (e) {
          L('✗ EXCEPTION: ' + (e?.message || e));
          console.error('[auth-callback] Exception:', e);
        }
      })();
    })();
  </script>
</body>
</html>
