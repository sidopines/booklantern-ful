<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Signing you in…</title>
  <style>
    body{font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
         margin:0;display:grid;place-items:center;height:100dvh;background:#0b0e14;color:#e5e7eb}
    .card{background:#111827;padding:28px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);max-width:680px}
    code, .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .muted{color:#9ca3af}
    .ok{color:#a7f3d0}
    .err{color:#fecaca}
    .hint{color:#93c5fd}
    a{color:#93c5fd}
  </style>
</head>
<body>
  <div class="card">
    <h2>Completing sign-in…</h2>
    <p class="muted">Hold on a moment while we verify your session.</p>
    <pre id="log" class="mono muted" style="white-space:pre-wrap"></pre>
  </div>

  <script type="module">
    // Minimal, dependency-free supabase-js loader (ESM)
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const logEl = document.getElementById('log');
    const log = (...args) => { logEl.textContent += args.join(' ') + "\n"; };

    const SUPABASE_URL = "<%= process.env.SUPABASE_URL %>";
    const SUPABASE_ANON_KEY = "<%= process.env.SUPABASE_ANON_KEY %>";

    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
      log("❌ Missing Supabase environment variables on server.");
      log("SUPABASE_URL:", SUPABASE_URL);
      log("SUPABASE_ANON_KEY present:", !!SUPABASE_ANON_KEY);
    }

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, detectSessionInUrl: false }
    });

    // Helper: parse the fragment `#access_token=...&refresh_token=...`
    const parseHash = () => {
      const h = location.hash?.startsWith("#") ? location.hash.slice(1) : "";
      const params = new URLSearchParams(h);
      return {
        access_token: params.get("access_token"),
        refresh_token: params.get("refresh_token"),
        token_type: params.get("token_type"),
        type: params.get("type"),
        expires_in: params.get("expires_in"),
      };
    };

    const nextFromQuery = () => {
      const u = new URL(location.href);
      const n = u.searchParams.get("next");
      return n && n.startsWith("/") ? n : null;
    };

    (async () => {
      try {
        log("• Callback loaded.");
        const tokens = parseHash();
        log("• Hash present:", !!location.hash, "type=", tokens.type);

        if (!tokens.access_token || !tokens.refresh_token) {
          // Some providers send `code` (PKCE). Try exchangeCodeForSession().
          const url = new URL(location.href);
          const hasCode = url.searchParams.get("code");
          if (hasCode) {
            log("• Found `code` param. Exchanging…");
            const { data, error } = await supabase.auth.exchangeCodeForSession(location.href);
            if (error) throw error;
            log("✅ Session established via code.");
          } else {
            throw new Error("No access/refresh tokens in URL fragment.");
          }
        } else {
          log("• Setting session via tokens…");
          const { error } = await supabase.auth.setSession({
            access_token: tokens.access_token,
            refresh_token: tokens.refresh_token
          });
          if (error) throw error;
          log("✅ Session established via tokens.");
        }

        // Small check: can we read the session?
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) throw new Error("Session not found after set.");

        log("• User:", session.user?.email || session.user?.id);

        // Redirect target
        const next = nextFromQuery() || "/account";
        log("• Redirecting to", next, "…");
        // Clear the hash before leaving
        history.replaceState(null, "", "/auth/callback");
        location.replace(next);
      } catch (e) {
        console.error(e);
        log("❌ Error:", e.message || e);
        log("• You can go back to the ", window.origin, " or <a href='/login'>login</a>.");
      }
    })();
  </script>
</body>
</html>
