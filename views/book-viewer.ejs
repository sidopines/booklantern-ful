<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('./partials/header.ejs', {
    pageTitle: `${book.title} | Read`,
    pageDescription: `Read ${book.title} from ${book.source}`
  }) %>
  <style>
    /* your existing styles‚Ä¶ */
  </style>
</head>
<body>
  <a href="javascript:history.back()" class="back-link">‚Üê Back</a>
  <h1><%= book.title %></h1>

  <% if (book.source === 'archive') { %>
    <iframe id="book-frame"
      src="https://archive.org/stream/<%= book.identifier %>?ui=embed#page=1"
      allowfullscreen>
    </iframe>
  <% } else if (book.source === 'gutenberg') { %>
    <p>This book is from Project Gutenberg. <a href="https://www.gutenberg.org/ebooks/<%= book.identifier %>">Open in Gutenberg</a>.</p>
  <% } else if (book.source === 'openlibrary') { %>
    <p>This book is from OpenLibrary. <a href="https://openlibrary.org/works/<%= book.identifier %>">Open in OpenLibrary</a>.</p>
  <% } %>

  <div class="action-buttons">
    <form method="POST" action="/read/book/<%= book.source %>/<%= book.identifier %>/favorite">
      <button <%= user ? '' : 'disabled' %>>
        <%= isFavorite ? '‚ùå Remove Favorite' : '‚ù§Ô∏è Add Favorite' %>
      </button>
    </form>
  </div>

  <div id="bookmark-status">‚è≥ Loading last saved page‚Ä¶</div>
  <script>
    const userLoggedIn = <%= !!user %>;
    const source       = "<%= book.source %>";
    const id           = "<%= book.identifier %>";
    const iframe       = document.getElementById('book-frame');
    const status       = document.getElementById('bookmark-status');

    if (book.source==='archive') {
      fetch(`/read/book/${source}/${id}/bookmark`)
        .then(r=>r.json()).then(d=>{
          const pg = d.page||1;
          iframe.src = `https://archive.org/stream/${id}?ui=embed#page=${pg}`;
          status.textContent = `üìñ Resuming from page ${pg}`;
        }).catch(_=> status.textContent="‚ö†Ô∏è Couldn't load bookmark.");

      function saveBM(){
        if(!userLoggedIn) return;
        const m = iframe.src.match(/#page=(\d+)/);
        if (!m) return;
        navigator.sendBeacon
          ? navigator.sendBeacon(`/read/book/${source}/${id}/bookmark`,
              JSON.stringify({page: parseInt(m[1],10)}))
          : fetch(`/read/book/${source}/${id}/bookmark`, {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({page: parseInt(m[1],10)})
            });
      }
      document.addEventListener('visibilitychange', ()=> {
        if (document.visibilityState==='hidden') saveBM();
      });
      window.addEventListener('beforeunload', saveBM);
    }
  </script>
</body>
</html>
