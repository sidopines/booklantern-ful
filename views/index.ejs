<%
// Guard all locals for defensive programming
const user = (typeof locals.user !== 'undefined') ? locals.user : null;
%>
<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('./partials/head.ejs', {
    pageTitle: 'BookLantern - Discover Books from Global Libraries',
    pageDescription: 'Search millions of books from globally trusted libraries. Find your next great read with one clean reader.'
  }) %>
</head>
<body data-page="home">
  <%- include('./partials/navbar.ejs') %>
  
  <%- include('./partials/hero.ejs') %>

  <!-- Book Carousels -->
  <main>
    <% 
    // Prepare deduped carousel data - defensive programming
    const trendingBooks = [
      { id: 'pride-prejudice', title: 'Pride and Prejudice', author: 'Jane Austen', cover: '/img/cover-fallback.svg', readUrl: '/read?id=pride-prejudice', source: 'openlibrary' },
      { id: 'republic-plato', title: 'The Republic', author: 'Plato', cover: '/img/cover-fallback.svg', readUrl: '/read?id=republic-plato', source: 'gutenberg' },
      { id: 'alice-wonderland', title: 'Alice\'s Adventures in Wonderland', author: 'Lewis Carroll', cover: '/img/cover-fallback.svg', readUrl: '/read?id=alice-wonderland', source: 'gutenberg' },
      { id: 'art-of-war', title: 'The Art of War', author: 'Sun Tzu', cover: '/img/cover-fallback.svg', readUrl: '/read?id=art-of-war', source: 'gutenberg' },
      { id: 'frankenstein', title: 'Frankenstein', author: 'Mary Shelley', cover: '/img/cover-fallback.svg', readUrl: '/read?id=frankenstein', source: 'gutenberg' },
      { id: '1984', title: '1984', author: 'George Orwell', cover: '/img/cover-fallback.svg', readUrl: '/read?id=1984', source: 'openlibrary' }
    ];

    const philosophyBooks = [
      { id: 'meditations', title: 'Meditations', author: 'Marcus Aurelius', cover: '/img/cover-fallback.svg', readUrl: '/read?id=meditations', source: 'gutenberg' },
      { id: 'beyond-good-evil', title: 'Beyond Good and Evil', author: 'Friedrich Nietzsche', cover: '/img/cover-fallback.svg', readUrl: '/read?id=beyond-good-evil', source: 'gutenberg' },
      { id: 'critique-pure-reason', title: 'The Critique of Pure Reason', author: 'Immanuel Kant', cover: '/img/cover-fallback.svg', readUrl: '/read?id=critique-pure-reason', source: 'gutenberg' },
      { id: 'social-contract', title: 'The Social Contract', author: 'Jean-Jacques Rousseau', cover: '/img/cover-fallback.svg', readUrl: '/read?id=social-contract', source: 'gutenberg' },
      { id: 'discourse-method', title: 'Discourse on Method', author: 'Ren√© Descartes', cover: '/img/cover-fallback.svg', readUrl: '/read?id=discourse-method', source: 'gutenberg' }
    ];

    const historyBooks = [
      { id: 'histories-herodotus', title: 'The Histories', author: 'Herodotus', cover: '/img/cover-fallback.svg', readUrl: '/read?id=histories-herodotus', source: 'gutenberg' },
      { id: 'american-crisis', title: 'The American Crisis', author: 'Thomas Paine', cover: '/img/cover-fallback.svg', readUrl: '/read?id=american-crisis', source: 'gutenberg' },
      { id: 'history-england', title: 'A History of England', author: 'Thomas Macaulay', cover: '/img/cover-fallback.svg', readUrl: '/read?id=history-england', source: 'gutenberg' },
      { id: 'civil-war-caesar', title: 'The Civil War', author: 'Julius Caesar', cover: '/img/cover-fallback.svg', readUrl: '/read?id=civil-war-caesar', source: 'gutenberg' }
    ];

    // Dedupe function to prevent cross-section duplicates
    function dedupeBooks(sections) {
      const seen = new Set();
      return sections.map(section => {
        const deduped = section.books.filter(book => {
          if (seen.has(book.id)) return false;
          seen.add(book.id);
          return true;
        });
        return { ...section, books: deduped };
      });
    }

    const allSections = [
      { id: 'trending', title: 'Trending on Open Library', books: trendingBooks },
      { id: 'philosophy', title: 'Philosophy Picks', books: philosophyBooks },
      { id: 'history', title: 'History Picks', books: historyBooks }
    ];

    const dedupedSections = dedupeBooks(allSections);
    %>

    <% dedupedSections.forEach(function(section) { %>
      <% if (section.books && section.books.length > 0) { %>
        <%- include('./partials/bookCarousel.ejs', {
          id: section.id,
          title: section.title,
          items: section.books
        }) %>
      <% } %>
    <% }) %>

    <!-- Why BookLantern Section -->
    <section class="content-section">
      <div class="container">
        <h2 class="section-title">Why BookLantern?</h2>
        <div class="content-grid">
          <div class="card">
            <div class="empty-icon">üìö</div>
            <h3>Millions+ titles</h3>
            <p>Access the largest collection of free books from globally trusted libraries and archives.</p>
          </div>
          
          <div class="card">
            <div class="empty-icon">üåç</div>
            <h3>From globally trusted libraries</h3>
            <p>Content sourced from the world's most respected public domain and open access collections.</p>
          </div>
          
          <div class="card">
            <div class="empty-icon">‚ú®</div>
            <h3>One clean reader</h3>
            <p>Beautiful, distraction-free reading experience optimized for focus and comprehension.</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <%- include('./partials/footer.ejs') %>
</body>
</html>