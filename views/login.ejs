<!doctype html>
<html lang="en">
<head>
  <%- include('./partials/head', {
    pageTitle: 'Login â€¢ BookLantern',
    pageDescription: 'Log in to save bookmarks and notes across devices.',
    canonicalUrl: (typeof canonicalUrl !== 'undefined' ? canonicalUrl : '')
  }) %>
</head>
<body>
  <%- include('./partials/navbar') %>
  <main class="container" style="max-width:700px; margin:28px auto; padding:0 16px;">
    <h1>Login</h1>
    <p class="ink-2">Use email & password, or continue with Google / Apple.</p>

    <form id="loginForm" class="card" style="padding:16px; margin-top:12px;">
      <div class="stack" style="--gap:10px;">
        <input class="input" type="email" id="email" placeholder="you@example.com" required>
        <input class="input" type="password" id="password" placeholder="Your password" required>
        <div class="row" style="gap:8px; flex-wrap:wrap;">
          <button class="btn btn-primary" type="submit">Log in</button>
          <button class="btn" id="reset" type="button">Send reset link</button>
        </div>
        <div class="row" style="gap:8px; flex-wrap:wrap;">
          <button class="btn" id="google" type="button">Continue with Google</button>
          <button class="btn" id="apple" type="button">Continue with Apple</button>
        </div>
        <div id="msg" class="ink-2"></div>
      </div>
    </form>
  </main>
  <%- include('./partials/footer') %>

  <script>
  (function(){
    const sb = window.supabaseClient;
    const msg = (t)=>{ document.getElementById('msg').textContent = t || ''; };

    document.getElementById('loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      msg('');
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const { error } = await sb.auth.signInWithPassword({ email, password });
      if (error) return msg(error.message);
      location.href = '/';
    });

    document.getElementById('reset').addEventListener('click', async ()=>{
      const email = document.getElementById('email').value.trim();
      const redirectTo = (location.origin || '<%= process.env.SITE_URL || "" %>') + '/auth/callback';
      const { error } = await sb.auth.resetPasswordForEmail(email, { redirectTo });
      if (error) return msg(error.message);
      msg('Reset link sent. Check your email.');
    });

    document.getElementById('google').addEventListener('click', async ()=>{
      const redirectTo = (location.origin || '<%= process.env.SITE_URL || "" %>') + '/auth/callback';
      await sb.auth.signInWithOAuth({ provider: 'google', options: { redirectTo } });
    });
    document.getElementById('apple').addEventListener('click', async ()=>{
      const redirectTo = (location.origin || '<%= process.env.SITE_URL || "" %>') + '/auth/callback';
      await sb.auth.signInWithOAuth({ provider: 'apple', options: { redirectTo } });
    });
  })();
  </script>
</body>
</html>
