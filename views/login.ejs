<!doctype html>
<html lang="en">
<head>
  <%- include('./partials/head', {
    pageTitle: 'Login â€¢ BookLantern',
    pageDescription: 'Log in to save bookmarks and notes across devices.',
    canonicalUrl: (typeof canonicalUrl !== 'undefined' ? canonicalUrl : '')
  }) %>
</head>
<body>
  <%- include('./partials/navbar') %>

  <main class="container" style="max-width:700px; margin:28px auto; padding:0 16px;">
    <h1>Login</h1>
    <p class="ink-2">Use your email and password, or continue with Google / Apple.</p>

    <!-- status banner -->
    <div id="banner" class="card" style="display:none; padding:10px; margin:12px 0;"></div>

    <form id="loginForm" class="card" style="padding:16px; margin-top:12px;" novalidate>
      <div class="stack" style="--gap:10px;">
        <input class="input" type="email" id="email" placeholder="you@example.com" autocomplete="email" required>
        <input class="input" type="password" id="password" placeholder="Your password" autocomplete="current-password" required>

        <div class="row" style="gap:8px; flex-wrap:wrap;">
          <button class="btn btn-primary" type="submit" id="loginBtn">Log in</button>
          <button class="btn" id="reset" type="button">Send reset link</button>
          <a class="btn" href="/register">Donâ€™t have an account? Create one</a>
        </div>

        <div class="ink-2" style="margin-top:-6px;">Forgot password? Use the reset link above.</div>

        <hr style="border:none; border-top:1px solid rgba(0,0,0,.08); margin:6px 0;">

        <div class="row" style="gap:8px; flex-wrap:wrap;">
          <button class="btn" id="google" type="button">Continue with Google</button>
          <button class="btn" id="apple" type="button">Continue with Apple</button>
        </div>

        <div id="msg" class="ink-2"></div>
      </div>
    </form>
  </main>

  <%- include('./partials/footer') %>

  <script>
  (function(){
    const sb = window.supabaseClient;
    const banner = document.getElementById('banner');
    const msgEl = document.getElementById('msg');
    const loginBtn = document.getElementById('loginBtn');

    function setBanner(text, tone){
      if (!text) {
        banner.style.display='none';
        banner.textContent='';
        return;
      }
      banner.style.display='block';
      banner.textContent = text;
      const bg = tone === 'ok'   ? '#e6f7ed'
               : tone === 'warn' ? '#fff6e5'
               : tone === 'error'? '#ffecec'
               : '#f5f5f5';
      banner.style.background = bg;
      banner.style.border = '1px solid rgba(0,0,0,.08)';
    }
    function setMsg(t){ msgEl.textContent = t || ''; }
    function getBase(){ return (location.origin || '<%= process.env.SITE_URL || "" %>'); }

    // --- Banners from query/fragment ---
    (function(){
      try {
        const qp = new URLSearchParams(location.search);
        const hash = new URLSearchParams((location.hash || '').replace(/^#/, ''));
        if (qp.has('confirmed')) setBanner('âœ… Your email has been verified. You can log in now.', 'ok');
        else if (qp.has('reset')) {
          const val = qp.get('reset');
          if (val === '1')   setBanner('ðŸ“¬ Check your inbox for a password reset link.', 'info');
          if (val === 'done')setBanner('âœ… Your password has been updated. Please log in.', 'ok');
        }
        const err = hash.get('error_description') || hash.get('error') || qp.get('error_description') || qp.get('error');
        if (err) setBanner('âš ï¸ ' + decodeURIComponent(err).replace(/\+/g, ' '), 'error');
      } catch(e) {}
    })();

    // --- Email/password login ---
    document.getElementById('loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      setMsg('');
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;

      loginBtn.disabled = true;
      loginBtn.textContent = 'Signing inâ€¦';

      const { error } = await sb.auth.signInWithPassword({ email, password });
      if (error) {
        setMsg(error.message);
        loginBtn.disabled = false;
        loginBtn.textContent = 'Log in';
        return;
      }
      location.href = '/account';
    });

    // --- Send reset email (redirects to our password form) ---
    document.getElementById('reset').addEventListener('click', async ()=>{
      setMsg('');
      const email = document.getElementById('email').value.trim();
      if (!email) return setMsg('Enter your email first.');
      const redirectTo = getBase() + '/auth/callback?type=recovery';
      const { error } = await sb.auth.resetPasswordForEmail(email, { redirectTo });
      if (error) return setMsg(error.message);
      // Show "check inbox" banner immediately
      const url = new URL(location.href);
      url.searchParams.set('reset','1');
      url.hash = '';
      history.replaceState(null, '', url.toString());
      setBanner('ðŸ“¬ Check your inbox for a password reset link.', 'info');
    });

    // --- OAuth ---
    document.getElementById('google').addEventListener('click', async ()=>{
      await sb.auth.signInWithOAuth({
        provider: 'google',
        options: { redirectTo: getBase() + '/auth/callback' }
      });
    });

    document.getElementById('apple').addEventListener('click', async ()=>{
      await sb.auth.signInWithOAuth({
        provider: 'apple',
        options: { redirectTo: getBase() + '/auth/callback' }
      });
    });
  })();
  </script>
</body>
</html>
