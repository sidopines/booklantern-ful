<%
function coverURL(it){
  if (it.coverLarge) return it.coverLarge;
  if (it.cover_url) return it.cover_url;
  if (it.coverUrl) return it.coverUrl;
  if (it.imageLarge) return it.imageLarge;
  if (it.image) return it.image;
  if (it.cover) return it.cover;
  if (it.thumbnail) return it.thumbnail;
  if (it.thumb) return it.thumb;
  if (it.cover_i) return `https://covers.openlibrary.org/b/id/${it.cover_i}-L.jpg`;
  if (it.isbn) return `https://covers.openlibrary.org/b/isbn/${encodeURIComponent(it.isbn)}-L.jpg`;
  if (it.openLibraryId) return `https://covers.openlibrary.org/b/olid/${encodeURIComponent(it.openLibraryId)}-L.jpg`;
  if (it.formats){ const f=it.formats, keys=['image/jpeg','image/jpg','image/png','image/*','thumbnail','cover']; for(const k of keys){ if(f[k]) return f[k]; } }
  return null;
}
const title = item.title || 'Untitled';
const author = item.author || '';
const cover = coverURL(item);
%>
<%
  const _loggedIn =
    (typeof loggedIn !== 'undefined' && !!loggedIn) ||
    (typeof user !== 'undefined' && !!user) ||
    (typeof currentUser !== 'undefined' && !!currentUser) ||
    false;

  const href  = item.href || '#';
  const gate  = _loggedIn ? href : `/login?next=${encodeURIComponent(href)}`;
const summary = (item.description || item.snippet || (title + (author?(' by '+author):''))).toString().slice(0,320);
function initials(t){ return (t||'B').split(/\s+/).slice(0,2).map(s=>s[0]).join('').toUpperCase(); }
%>
<article class="card hover" role="listitem" style="min-width:200px">
  <div class="book-cover">
    <% if (cover) { %>
      <img class="cover-img" src="<%= cover %>" alt="Cover: <%= title %>" loading="lazy" referrerpolicy="no-referrer"
           onerror="this.style.display='none'; this.nextElementSibling?.classList.remove('hidden');">
      <div class="cover-ph hidden"><%= initials(title) %></div>
    <% } else { %>
      <div class="cover-ph"><%= initials(title) %></div>
    <% } %>
  </div>
  <div class="stack" style="--gap:6px">
    <div class="book-title"><%= title %></div>
    <% if (author) { %><div class="book-author"><%= author %></div><% } %>
    <div class="card-ctas">
      <a class="btn" href="<%= gate %>">Read</a>
      <button class="btn secondary" type="button" data-bl-listen="<%- summary.replace(/"/g,'&quot;') %>">Listen</button>
    </div>
  </div>
</article>