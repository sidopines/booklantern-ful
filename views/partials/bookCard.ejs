<%
// Book card with robust cover resolver and event delegation - defensive programming
const book = (typeof locals.book !== 'undefined') ? locals.book : {};
const user = (typeof locals.user !== 'undefined') ? locals.user : null;

// Robust cover URL resolver - check many common fields and OL cover_i
function coverURL(item){
  if (item.coverLarge) return item.coverLarge;
  if (item.cover_url) return item.cover_url;
  if (item.coverUrl) return item.coverUrl;
  if (item.imageLarge) return item.imageLarge;
  if (item.image) return item.image;
  if (item.cover) return item.cover;
  if (item.thumbnail) return item.thumbnail;
  if (item.thumb) return item.thumb;
  if (item.cover_i) return `https://covers.openlibrary.org/b/id/${item.cover_i}-L.jpg`;
  if (item.isbn) return `https://covers.openlibrary.org/b/isbn/${encodeURIComponent(item.isbn)}-L.jpg`;
  if (item.openLibraryId) return `https://covers.openlibrary.org/b/olid/${encodeURIComponent(item.openLibraryId)}-L.jpg`;
  if (item.formats){
    const f = item.formats;
    const keys = ['image/jpeg','image/jpg','image/png','image/*','thumbnail','cover'];
    for (const k of keys){ if (f[k]) return f[k]; }
  }
  return null;
}

const href = book.href || book.readUrl || book.url || '#';
const gate = user ? href : `/login?next=${encodeURIComponent(href)}`;
const title = book.title || 'Untitled';
const author = book.author || book.creator || '';
const cover = coverURL(book);
const summary = (book.description || book.snippet || book.subtitle || (title + (author ? (' by ' + author) : ''))).toString().slice(0,320);

function initials(t){ 
  return (t||'B').split(/\s+/).slice(0,2).map(s=>s[0]).join('').toUpperCase(); 
}
%>

<article class="card hover" role="listitem" style="min-width:200px">
  <div class="book-cover">
    <% if (cover) { %>
      <img src="<%= cover %>" alt="Cover: <%= title %>"
           referrerpolicy="no-referrer" loading="lazy"
           style="width:100%;height:180px;object-fit:cover;border-radius:12px"
           onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling?.classList.remove('hidden');">
      <div class="cover-ph hidden"><%= initials(title) %></div>
    <% } else { %>
      <div class="cover-ph"><%= initials(title) %></div>
    <% } %>
  </div>
  
  <div class="stack" style="--gap:6px">
    <div class="book-title" title="<%= title %>"><%= title %></div>
    <% if (author) { %><div class="book-author" title="<%= author %>"><%= author %></div><% } %>
    <div class="card-ctas" style="margin-top:8px">
      <a class="btn" href="<%= gate %>">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
          <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
        </svg>
        Read
      </a>
      <button class="btn secondary" type="button" data-bl-listen="<%- summary.replace(/"/g, '&quot;') %>">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="11,5 6,9 2,9 2,15 6,15 11,19 11,5"></polygon>
          <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
          <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
        </svg>
        Listen
      </button>
    </div>
  </div>
</article>