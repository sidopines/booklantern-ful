<!-- views/partials/header.ejs (FINAL FIXED FULL FILE) -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<%
  const _title = (typeof pageTitle !== 'undefined' && pageTitle) ? pageTitle : 'BookLantern';
  const _desc  = (typeof pageDescription !== 'undefined' && pageDescription) ? pageDescription : 'Free books & educational videos.';
  const _img   = (typeof pageImage !== 'undefined' && pageImage) ? pageImage : '/public/img/brand.svg';
  let _url = '';
  try { if (typeof req !== 'undefined' && req) { _url = `${req.protocol}://${req.get('host')}${req.originalUrl}`; } } catch (e) {}
%>

<title><%= _title %></title>
<meta name="description" content="<%= _desc %>" />

<!-- Open Graph / Twitter -->
<meta property="og:title" content="<%= _title %>" />
<meta property="og:description" content="<%= _desc %>" />
<meta property="og:type" content="website" />
<% if (_url) { %><meta property="og:url" content="<%= _url %>" /><% } %>
<meta property="og:image" content="<%= _img %>" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="<%= _title %>" />
<meta name="twitter:description" content="<%= _desc %>" />
<meta name="twitter:image" content="<%= _img %>" />

<!-- Supabase env -->
<meta name="bl-sb-url" content="<%= process.env.SUPABASE_URL || '' %>" />
<meta name="bl-sb-anon" content="<%= process.env.SUPABASE_ANON_KEY || process.env.SUPABASE_PUBLIC_ANON_KEY || '' %>" />

<!-- CSP -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self' https: data: blob:;
  img-src 'self' https: data: blob:;
  script-src 'self' 'unsafe-inline' https:;
  style-src 'self' 'unsafe-inline' https:;
  frame-src 'self' https://archive.org https://www.gutenberg.org https://openlibrary.org https://*.openlibrary.org https://*.internetarchive.org https://iiif.archive.org;
  connect-src 'self' https:;
" />

<!-- Icons -->
<link rel="manifest" href="/public/site.webmanifest" />
<link rel="icon" type="image/png" sizes="32x32" href="/public/favicon-32x32.png" />
<link rel="icon" type="image/png" sizes="16x16" href="/public/favicon-16x16.png" />
<link rel="apple-touch-icon" href="/public/apple-touch-icon.png" />
<link rel="icon" href="/favicon.ico" />

<!-- CSS -->
<link rel="stylesheet" href="/public/css/nav.css?v=<%= Date.now() %>" />
<link rel="stylesheet" href="/public/css/site.css?v=<%= Date.now() %>" />
<link rel="stylesheet" href="/public/css/hero.css?v=<%= Date.now() %>" />
<link rel="stylesheet" href="/public/css/carousel.css?v=<%= Date.now() %>" />
<link rel="stylesheet" href="/public/css/footer.css?v=<%= Date.now() %>" />

<!-- JS -->
<script defer src="/public/js/theme.js?v=<%= Date.now() %>"></script>

<!-- Initialize Supabase client globally -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  (function () {
    try {
      var url  = (document.querySelector('meta[name="bl-sb-url"]')  || {}).content || '';
      var anon = (document.querySelector('meta[name="bl-sb-anon"]') || {}).content || '';
      if (!url || !anon) {
        console.warn('[supabase] Missing env vars');
        window.supabaseClient = null;
        return;
      }
      if (window.supabase && !window.supabaseClient) {
        window.supabaseClient = window.supabase.createClient(url, anon, {
          auth: {
            persistSession: true,
            autoRefreshToken: true,
            detectSessionInUrl: true,
            flowType: 'pkce'
          }
        });
      }
    } catch (e) {
      console.error('[supabase] init failed', e);
      window.supabaseClient = null;
    }
  })();
</script>
