<!-- views/partials/navbar.ejs -->
<header class="topbar" role="navigation" aria-label="Primary">
  <!-- Left: brand -->
  <a class="brand row" href="/">
    <img src="/public/img/brand.svg" alt="" width="22" height="22"
         onerror="this.onerror=null;this.src='/public/favicon.svg';" />
    <span class="brand-name">BookLantern</span>
  </a>

  <!-- Center: primary links -->
  <ul class="nav-links row" aria-label="Site">
    <li><a href="/read">Read</a></li>
    <li><a href="/watch">Watch</a></li>
    <li><a href="/about">About</a></li>
    <li><a href="/contact">Contact</a></li>
  </ul>

  <!-- Right: search + toggle + auth -->
  <div class="actions row">
    <form class="nav-search row" action="/search" method="get" role="search">
      <input class="input" type="text" name="q" placeholder="Search free books…" aria-label="Search free books">
      <button class="btn" type="submit">Search</button>
    </form>

    <!-- Theme toggle (works with /public/js/theme.js; also has a tiny fallback below) -->
    <button id="themeToggle" class="btn icon-btn" type="button" aria-label="Toggle theme" aria-pressed="false" title="Toggle theme">
      <span aria-hidden="true">•</span>
    </button>

    <!-- Auth (guest vs user). Default to guest to avoid logged-in info flicker. -->
    <div id="auth-guest" class="row" style="gap:8px;">
      <a class="btn" href="/login">Login</a>
      <a class="btn btn-primary equal" href="/register">Create account</a>
    </div>

    <div id="auth-user" class="row" style="gap:8px; display:none;" aria-hidden="true">
      <a class="btn" href="/account">Account</a>
      <button id="navSignOut" class="btn" type="button">Sign out</button>
    </div>
  </div>
</header>

<script>
/* ---------- Auth state swap (Supabase) ---------- */
(function () {
  var guest = document.getElementById('auth-guest');
  var user = document.getElementById('auth-user');
  var sb = window.supabaseClient;

  function showGuest(){
    if (guest){ guest.style.display = 'flex'; guest.setAttribute('aria-hidden', 'false'); }
    if (user){ user.style.display = 'none'; user.setAttribute('aria-hidden', 'true'); }
  }
  function showUser(){
    if (user){ user.style.display = 'flex'; user.setAttribute('aria-hidden', 'false'); }
    if (guest){ guest.style.display = 'none'; guest.setAttribute('aria-hidden', 'true'); }
  }

  async function refreshAuthUI() {
    try {
      if (!sb || !sb.auth || !sb.auth.getUser) { showGuest(); return; }
      var res = await sb.auth.getUser();
      if (res && res.data && res.data.user) {
        showUser();
      } else {
        showGuest();
      }
    } catch (e) {
      // On any error, prefer the safer guest state.
      showGuest();
    }
  }

  // Initial check
  refreshAuthUI();

  // Keep it in sync if auth changes (e.g., another tab logs in/out)
  try {
    sb && sb.auth && sb.auth.onAuthStateChange && sb.auth.onAuthStateChange(function(){ refreshAuthUI(); });
  } catch (e) {}

  // Sign out button
  var signOutBtn = document.getElementById('navSignOut');
  if (signOutBtn) {
    signOutBtn.addEventListener('click', async function(){
      try { await (sb && sb.auth && sb.auth.signOut ? sb.auth.signOut() : Promise.resolve()); } catch (e) {}
      // After sign out, send them home.
      location.href = '/';
    });
  }
})();

/* ---------- Theme toggle fallback ----------
   If your /public/js/theme.js is present (as linked in head.ejs), both are safe (idempotent). */
(function () {
  var btn = document.getElementById('themeToggle');
  if (!btn) return;
  var KEY = 'bl-theme';
  function getMode(){
    try{
      var m = localStorage.getItem(KEY) || 'auto';
      if (m === 'auto') {
        var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        m = prefersDark ? 'dark' : 'light';
      }
      return m;
    }catch(e){ return 'light'; }
  }
  function setMode(m){
    try{ localStorage.setItem(KEY, m); }catch(e){}
    document.documentElement.setAttribute('data-theme', m);
    btn.setAttribute('aria-pressed', m === 'dark');
  }
  setMode(getMode());
  btn.addEventListener('click', function(){
    var current = getMode();
    setMode(current === 'dark' ? 'light' : 'dark');
  });
})();
</script>
