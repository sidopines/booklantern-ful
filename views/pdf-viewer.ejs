<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('./partials/head.ejs', {
    pageTitle: (typeof pageTitle !== 'undefined' && pageTitle) ? pageTitle : 'PDF Viewer',
    pageDescription: 'Read PDFs inline with a simple viewer.'
  }) %>
  <style>
    body{margin:0;background:#0b1220}
    .topbar{
      position:sticky;top:0;z-index:10;display:flex;gap:.5rem;align-items:center;
      padding:.5rem .75rem;background:rgba(15,23,42,.85);backdrop-filter:blur(8px);
      color:#e5e7eb;border-bottom:1px solid rgba(255,255,255,.08)
    }
    .topbar .title{font-weight:700;margin-left:.25rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .spacer{flex:1}
    .btn{border:1px solid rgba(255,255,255,.18);background:#111827;color:#fff;padding:.45rem .75rem;border-radius:.6rem;text-decoration:none;font-weight:700}
    .viewer{height:calc(100vh - 56px)}
    .viewer iframe{width:100%;height:100%;border:0;background:#1f2937}
    .fallback{padding:1rem;color:#e5e7eb}
  </style>
</head>
<body>
  <%- include('./partials/navbar.ejs') %>

  <% 
    const src   = (typeof pdfUrl !== 'undefined' && pdfUrl) ? pdfUrl : (typeof query !== 'undefined' && query.src ? query.src : '');
    const title = (typeof pageTitle !== 'undefined' && pageTitle) ? pageTitle : (typeof query !== 'undefined' && query.title ? query.title : 'PDF');
  %>

  <div class="topbar">
    <a class="btn" href="javascript:history.back()">← Back</a>
    <div class="title"><%= title %></div>
    <div class="spacer"></div>
    <% if (src) { %>
      <a class="btn" href="<%= src %>" target="_blank" rel="noopener">Open externally ↗</a>
    <% } %>
  </div>

  <div class="viewer" id="viewer-container">
    <% if (src) { %>
      <!-- Preflight validates %PDF signature before loading iframe -->
      <div id="pdf-loading" style="padding:2rem;color:#94a3b8;text-align:center">Validating PDF…</div>
      <iframe id="pdf-frame" style="display:none" title="PDF"></iframe>
      <div id="pdf-fallback" style="display:none;padding:2rem;color:#e5e7eb;text-align:center">
        <p style="font-size:1.1rem;margin-bottom:1rem">This PDF cannot be displayed inline.</p>
        <a class="btn" href="<%= src %>" target="_blank" rel="noopener">Open externally ↗</a>
      </div>
      <script>
      (function(){
        var src = "<%= src %>";
        var frame = document.getElementById('pdf-frame');
        var loading = document.getElementById('pdf-loading');
        var fallback = document.getElementById('pdf-fallback');

        // Determine if src is same-origin (proxy) or external URL
        var isExternal = /^https?:\/\//i.test(src) && !src.startsWith(window.location.origin);

        function showIframe(url) {
          loading.style.display = 'none';
          frame.style.display = 'block';
          frame.style.width = '100%';
          frame.style.height = '100%';
          frame.style.border = '0';
          frame.style.background = '#1f2937';
          frame.src = url + (url.includes('#') ? '' : '#view=FitH');
        }

        function showFallback() {
          loading.style.display = 'none';
          fallback.style.display = 'block';
        }

        if (isExternal) {
          // External URL: skip preflight (CORS would block Range fetch)
          // Just iframe it directly — browser handles cross-origin PDF rendering
          console.log('[pdf-viewer] External URL, skipping preflight:', src.substring(0, 80));
          showIframe(src);
        } else {
          // Same-origin (proxy): preflight to validate %PDF signature
          fetch(src, { method: 'GET', headers: { Range: 'bytes=0-15' }, credentials: 'omit' })
            .then(function(r){
              // Handle JSON redirect response from proxy (OpenStax fallback)
              var ct = (r.headers.get('content-type') || '').toLowerCase();
              if (ct.includes('application/json')) {
                return r.json().then(function(data) {
                  if (data && data.redirect) {
                    console.log('[pdf-viewer] Proxy returned redirect, iframing:', data.redirect);
                    showIframe(data.redirect);
                    return null; // skip further processing
                  }
                  throw new Error('Unexpected JSON from proxy');
                });
              }
              // Handle 302 redirect (browser follows automatically, but check status)
              if (!r.ok && r.status !== 206) throw new Error('HTTP ' + r.status);
              return r.arrayBuffer();
            })
            .then(function(buf){
              if (!buf) return; // already handled (JSON redirect)
              var bytes = new Uint8Array(buf);
              // %PDF = 0x25 0x50 0x44 0x46
              if (bytes.length >= 4 && bytes[0]===0x25 && bytes[1]===0x50 && bytes[2]===0x44 && bytes[3]===0x46) {
                // Valid PDF — show iframe
                showIframe(src);
              } else {
                // Not a valid PDF — check if it's HTML (error page)
                var text = '';
                try { text = new TextDecoder().decode(bytes).toLowerCase(); } catch(e){}
                console.warn('[pdf-viewer] Invalid PDF signature:', Array.from(bytes.slice(0,4)).map(function(b){return b.toString(16)}).join(' '), text.slice(0,50));
                showFallback();
              }
            })
            .catch(function(err){
              console.warn('[pdf-viewer] Preflight failed:', err);
              // Fallback: try loading anyway (might work for some servers that block Range)
              showIframe(src);
            });
        }
      })();
      </script>
    <% } else { %>
      <div class="fallback">No PDF provided.</div>
    <% } %>
  </div>
</body>
</html>
