<%- include('partials/head', { title: pageTitle || (video && video.title) || 'Video • BookLantern' }) %>
<%- include('partials/header') %>

<main class="container mx-auto px-4 py-8">
  <section class="mb-8">
    <h1 class="text-3xl font-semibold mb-3"><%= video.title %></h1>
    <% if (video.description) { %>
      <p class="text-base text-gray-600 mb-6"><%= video.description %></p>
    <% } %>

    <div class="video-player">
      <% const raw = (typeof rawUrl !== 'undefined' ? rawUrl : (video.source_url || video.url || video.link)); %>

      <% if (embedUrl) { %>
        <div class="iframe-16x9">
          <iframe
            id="bl-iframe"
            src="<%= embedUrl %>"
            title="<%= video.title %>"
            loading="lazy"
            referrerpolicy="strict-origin-when-cross-origin"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen
            frameborder="0"
            width="100%" height="100%">
          </iframe>
        </div>

        <!-- Fallback container (hidden initially) -->
        <div id="bl-fallback" class="iframe-16x9 blocked" style="display:none">
          <div class="blocked-msg">
            <div class="mb-2">We can’t embed this source.</div>
            <% if (raw) { %>
              <a class="btn btn-primary" href="<%= raw %>" target="_blank" rel="noopener">
                Open on source site
              </a>
            <% } else { %>
              <div class="text-gray-500">No URL was provided for this video.</div>
            <% } %>
          </div>
        </div>
      <% } else { %>
        <div class="iframe-16x9 blocked">
          <div class="blocked-msg">
            <div class="mb-2">We can’t embed this source.</div>
            <% if (raw) { %>
              <a class="btn btn-primary" href="<%= raw %>" target="_blank" rel="noopener">
                Open on source site
              </a>
            <% } else { %>
              <div class="text-gray-500">No URL was provided for this video.</div>
            <% } %>
          </div>
        </div>
      <% } %>
    </div>
  </section>

  <section class="mt-10">
    <a class="inline-flex items-center gap-2 text-sm underline" href="/watch">
      ← Back to Watch
    </a>
  </section>
</main>

<style>
  .iframe-16x9 { position: relative; width: 100%; max-width: 1100px; margin: 0 auto; }
  .iframe-16x9::before { content: ""; display: block; padding-top: 56.25%; } /* 16:9 */
  .iframe-16x9 > iframe { position: absolute; inset: 0; width: 100%; height: 100%; border: 0; border-radius: 16px; }
  .iframe-16x9.blocked { background: var(--surface-2, #f2f3f5); border-radius: 16px; display: grid; place-items: center; color: #666; min-height: 320px; }
  .blocked-msg { padding: 2rem; text-align: center; }
  .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.65rem 1rem; border-radius: 999px; text-decoration: none; }
  .btn-primary { background: var(--accent, #111); color: #fff; }
  .container { max-width: 1100px; }
</style>

<script>
  // If the iframe fails to load (X-Frame-Options / CSP / network),
  // show the graceful fallback with "Open on source site".
  (function () {
    const iframe = document.getElementById('bl-iframe');
    if (!iframe) return;

    const showFallback = () => {
      const fb = document.getElementById('bl-fallback');
      if (!fb) return;
      iframe.parentElement.style.display = 'none';
      fb.style.display = 'block';
    };

    // Some browsers won't fire onerror for blocked iframes; add a timeout.
    let loaded = false;
    iframe.addEventListener('load', () => { loaded = true; }, { once: true });
    iframe.addEventListener('error', showFallback, { once: true });

    // If nothing has loaded after 4s, assume blocked and swap.
    setTimeout(() => { if (!loaded) showFallback(); }, 4000);
  })();
</script>

<%- include('partials/footer') %>
