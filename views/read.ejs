<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('./partials/header.ejs', {
    pageTitle: 'Read Books Online',
    pageDescription: "Browse and read books fetched from multiple free sources using BookLantern's modern reader experience."
  }) %>
  <style>
    body {
      font-family: 'Georgia', serif;
      background: #fffaf5;
      color: #333;
      margin: 0;
      padding: 2rem;
    }
    .back-link {
      display: inline-block;
      margin-bottom: 1rem;
      color: #0077cc;
      text-decoration: none;
      font-size: 0.9rem;
    }
    .back-link:hover { text-decoration: underline; }
    h1 { text-align: center; margin-bottom: 2rem; }
    form { text-align: center; margin-bottom: 2rem; }
    input[type="text"] {
      width: 60%;
      max-width: 520px;
      padding: 0.6rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      padding: 0.6rem 1.2rem;
      margin-left: 1rem;
      font-size: 1rem;
      background: #222;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .book-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-top: 2rem;
    }
    .book-card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 1rem;
      text-align: center;
      transition: transform 0.15s ease;
    }
    .book-card:hover { transform: translateY(-4px); }
    .book-card img {
      width: 100%;
      height: 280px;
      object-fit: cover;
      border-radius: 5px;
      background: #eee;
    }
    .book-card h3 { margin: 0.6rem 0; font-size: 1.05rem; }
    .book-card p { font-size: 0.9rem; color: #666; margin: 0.3rem 0 0.6rem; }
    .meta-row {
      display: flex; justify-content: center; align-items: center; gap: .5rem;
      flex-wrap: wrap; margin-top: .4rem;
    }
    .badge {
      display: inline-block;
      font-size: .75rem;
      background: #eef4ff;
      color: #1256b3;
      border: 1px solid #d6e4ff;
      padding: .2rem .5rem;
      border-radius: 999px;
    }
    .book-card a {
      text-decoration: none;
      color: #0077cc;
      font-weight: bold;
    }
    .book-card a:hover { text-decoration: underline; }
    .empty {
      text-align: center;
      color: #777;
      margin-top: 3rem;
      font-size: 1.1rem;
    }
  </style>
</head>
<body>
  <a href="javascript:history.back()" class="back-link">‚Üê Back</a>
  <h1>üìö Explore Free Books</h1>

  <form action="/read" method="GET">
    <input
      type="text"
      name="query"
      placeholder="Search books by title or author"
      value="<%= typeof query !== 'undefined' ? query : '' %>">
    <button type="submit">Search</button>
  </form>

  <% if (!books || books.length === 0) { %>
    <div class="empty">No books found. Try another search term.</div>
  <% } else { %>
    <div class="book-grid">
      <% books.forEach(book => { 
           const src = (book.source || '').toLowerCase();
           const id  = book.identifier || book._id || '';
      %>
        <div class="book-card">
          <img
            src="<%= book.cover || 'https://via.placeholder.com/200x280?text=No+Cover' %>"
            alt="<%= book.title %>">
          <h3><%= book.title %></h3>
          <p><%= book.creator || book.author || '' %></p>
          <div class="meta-row">
            <% if (src) { %><span class="badge"><%= src === 'archive' ? 'Archive.org' : (src === 'gutenberg' ? 'Project Gutenberg' : (src === 'openlibrary' ? 'OpenLibrary' : src)) %></span><% } %>
          </div>
          <div style="margin-top:.6rem;">
            <% if (src) { %>
              <a href="/read/book/<%= src %>/<%= encodeURIComponent(id) %>">üìñ Read Now</a>
            <% } else { %>
              <!-- Fallback: legacy local DB book -->
              <a href="/read/book/<%= encodeURIComponent(id) %>">üìñ Read Now</a>
            <% } %>
          </div>
        </div>
      <% }) %>
    </div>
  <% } %>
</body>
</html>
