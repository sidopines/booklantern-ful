<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('./partials/header.ejs', {
    pageTitle: 'Read Books Online',
    pageDescription: "Browse and read books fetched from multiple free sources using BookLantern's modern reader experience."
  }) %>
  <style>
    body { font-family: 'Georgia', serif; background:#fffaf5; color:#333; margin:0; padding:2rem; }
    .back-link { display:inline-block; margin-bottom:1rem; color:#0077cc; text-decoration:none; font-size:.9rem; }
    .back-link:hover { text-decoration:underline; }
    h1 { text-align:center; margin-bottom:2rem; }
    form { text-align:center; margin-bottom:2rem; }
    input[type="text"]{ width:60%; max-width:520px; padding:.6rem; font-size:1rem; border:1px solid #ccc; border-radius:5px; }
    button{ padding:.6rem 1.2rem; margin-left:1rem; font-size:1rem; background:#222; color:#fff; border:none; border-radius:5px; cursor:pointer; }
    .book-grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(200px,1fr)); gap:1.5rem; margin-top:2rem; }
    .book-card{ background:#fff; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.1); padding:1rem; text-align:center; transition:transform .15s ease; }
    .book-card:hover{ transform:translateY(-4px); }
    .thumb{ width:100%; height:280px; border-radius:5px; background:#eee; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .no-cover{ color:#999; font-size:.9rem; }
    .book-card h3{ margin:.6rem 0; font-size:1.05rem; }
    .book-card p{ font-size:.9rem; color:#666; margin:.3rem 0 .6rem; }
    .meta-row{ display:flex; justify-content:center; align-items:center; gap:.5rem; flex-wrap:wrap; margin-top:.4rem; }
    .badge{ display:inline-block; font-size:.75rem; background:#eef4ff; color:#1256b3; border:1px solid #d6e4ff; padding:.2rem .5rem; border-radius:999px; }
    .action a{ text-decoration:none; color:#0077cc; font-weight:bold; }
    .action a:hover{ text-decoration:underline; }
    .empty{ text-align:center; color:#777; margin-top:3rem; font-size:1.1rem; }
  </style>
</head>
<body>
  <%- include('./partials/navbar.ejs') %>

  <a href="javascript:history.back()" class="back-link">‚Üê Back</a>
  <h1>üìö Explore Free Books</h1>

  <form action="/read" method="GET">
    <input type="text" name="query" placeholder="Search books by title or author" value="<%= typeof query !== 'undefined' ? query : '' %>">
    <button type="submit">Search</button>
  </form>

  <% if (!books || books.length === 0) { %>
    <div class="empty">No books found. Try another search term.</div>
  <% } else { %>
    <div class="book-grid">
      <% books.forEach(function(book){
           const src  = (book.source || '').toLowerCase();
           const id   = book.identifier || book._id || '';
           const iaId = book.archiveId || ''; // if present, open with internal Archive viewer

           // Choose link:
           // - If we have an archiveId (e.g., OL with IA scan, or Archive source), open internally
           // - Else if Gutenberg, route to our Gutenberg wrapper
           // - Else open external readerUrl in a new tab
           const isInternalArchive = !!iaId || src === 'archive';
           const isGutenberg       = (src === 'gutenberg');
           const gutenId           = isGutenberg ? String(id).replace(/^gutenberg:/,'') : '';

           const href = isInternalArchive
              ? `/read/book/${encodeURIComponent(iaId || id)}`
              : (isGutenberg
                  ? `/read/gutenberg/${encodeURIComponent(gutenId)}${book.readerUrl ? ('?u=' + encodeURIComponent(book.readerUrl)) : ''}`
                  : (book.readerUrl || '#'));
      %>
        <div class="book-card">
          <a href="<%= href %>" <%= (isInternalArchive || isGutenberg) ? '' : 'target="_blank" rel="noopener"' %>>
            <div class="thumb">
              <% if (book.cover) { %><img src="<%= book.cover %>" alt="<%= book.title %>"><% } else { %><div class="no-cover">No Cover</div><% } %>
            </div>
          </a>
          <h3><%= book.title %></h3>
          <p><%= book.creator || book.author || '' %></p>
          <div class="meta-row">
            <% if (src) { %>
              <span class="badge">
                <%= src === 'archive' ? 'Archive.org' : (src === 'gutenberg' ? 'Project Gutenberg' : (src === 'openlibrary' ? 'Open Library' : src)) %>
              </span>
            <% } %>
          </div>
          <div class="action" style="margin-top:.6rem;">
            <a href="<%= href %>" <%= (isInternalArchive || isGutenberg) ? '' : 'target="_blank" rel="noopener"' %>>üìñ Read Now</a>
          </div>
        </div>
      <% }) %>
    </div>
  <% } %>
</body>
</html>
