<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('partials/header'); %>
</head>
<body>
  <%- include('partials/navbar'); %>

  <main class="page-wrap" style="max-width:900px;margin:32px auto 72px;">
    <h1 class="page-title">Create account</h1>

    <section class="card" style="border:1px solid #eee;border-radius:12px;padding:16px;background:#fff;">
      <div id="msg" style="display:none;margin:0 0 12px;padding:10px;border-radius:8px;"></div>

      <p>We'll email you a one-time link to finish creating your account.</p>

      <form id="register-form" class="login-form" onsubmit="return false;" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
        <input id="reg-email" type="email" placeholder="you@example.com" required
               style="flex:1;min-width:260px;padding:10px;border:1px solid #ddd;border-radius:8px;">
        <button id="sendRegLink" class="btn" type="button">Send sign-up link</button>
        <a class="btn btn-ghost" href="/login">Already have an account? Log in</a>
      </form>

      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;">
        <a class="btn" href="/auth/oauth/google">Continue with Google</a>
        <a class="btn" href="/auth/oauth/apple">Continue with Apple</a>
      </div>
    </section>
  </main>

  <%- include('partials/footer'); %>

  <%- include('partials/auth-boot') %>
  <script>
(function () {
  const sb    = window.supabaseClient;
  // a) handle ?code= after OAuth/magic verify
  (async () => {
    const url = new URL(window.location.href);
    const code = url.searchParams.get('code');
    const errorDesc = url.searchParams.get('error_description');
    const el = document.querySelector('#msg') || document.querySelector('#register-error');
    if (errorDesc && el) { el.textContent = decodeURIComponent(errorDesc); el.style.display = 'block'; el.style.color = '#b00020'; }
    if (code) {
      const { error } = await sb.auth.exchangeCodeForSession(window.location.href);
      if (error) { console.error('[auth] exchange error:', error.message); if (el) { el.textContent = error.message; el.style.display = 'block'; el.style.color = '#b00020'; } }
      else { window.location.replace(url.searchParams.get('next') || '/'); }
    }
    // also handle non-PKCE OTP tokens in hash
    if (!code && window.location.hash && window.location.hash.length > 1) {
      const hash = new URLSearchParams(window.location.hash.slice(1));
      const access_token  = hash.get('access_token');
      const refresh_token = hash.get('refresh_token');
      if (access_token && refresh_token) {
        const { error } = await sb.auth.setSession({ access_token, refresh_token });
        if (error) { console.error('[auth] setSession error:', error.message); if (el) { el.textContent = error.message; el.style.display = 'block'; el.style.color = '#b00020'; } }
        else {
          history.replaceState(null, '', url.pathname + url.search);
          window.location.replace(url.searchParams.get('next') || '/');
        }
      }
    }
  })();

  // b) Google / Apple buttons
  const go = async (prov) => {
    const redirectTo = "<%= redirectTo %>";
    const { error } = await sb.auth.signInWithOAuth({ provider: prov, options: { redirectTo } });
    if (error) { const el = document.querySelector('#msg'); if (el) { el.textContent = error.message; el.style.display = 'block'; el.style.color = '#b00020'; } }
  };
  document.querySelector('a[href*="/auth/oauth/google"]')?.addEventListener('click', (e) => { e.preventDefault(); go('google'); });
  document.querySelector('a[href*="/auth/oauth/apple"]')?.addEventListener('click', (e) => { e.preventDefault(); go('apple'); });

  // c) Magic-link sender
  const input = document.querySelector('#register-email') || document.querySelector('#reg-email') || document.querySelector('input[type="email"]');
  const btn   = document.querySelector('#send-signup')    || document.querySelector('#sendRegLink') || document.querySelector('button[type="submit"]');
  const msgEl = document.querySelector('#msg');
  if (!sb) { if (msgEl) { msgEl.textContent = 'Auth client failed to load.'; msgEl.style.display = 'block'; msgEl.style.color = '#b00020'; } return; }

  if (btn && input) {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      if (msgEl) msgEl.textContent = '';
      const email = (input.value || '').trim();
      if (!email) { if (msgEl) { msgEl.textContent = 'Please enter an email.'; msgEl.style.display = 'block'; msgEl.style.color = '#b00020'; } return; }
      const redirectTo = "<%= redirectTo %>";
      const { error } = await sb.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: redirectTo }
      });
      if (error) { console.error('[auth] OTP error:', error.message); if (msgEl) { msgEl.textContent = error.message; msgEl.style.display = 'block'; msgEl.style.color = '#b00020'; } }
      else { if (msgEl) { msgEl.textContent = 'Sign-up link sent. Check your email.'; msgEl.style.display = 'block'; msgEl.style.color = '#0a7e0a'; } }
    });
  }
})();
  </script>
</body>
</html>
