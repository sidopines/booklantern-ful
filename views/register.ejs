<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('partials/header'); %>
</head>
<body>
  <%- include('partials/navbar'); %>

  <main class="page-wrap" style="max-width:900px;margin:32px auto 72px;">
    <h1 class="page-title">Create account</h1>

    <section class="card" style="border:1px solid #eee;border-radius:12px;padding:16px;background:#fff;">
      <div id="msg" style="display:none;margin:0 0 12px;padding:10px;border-radius:8px;"></div>

      <p>We’ll email you a one-time link to finish creating your account.</p>

      <form id="register-form" class="login-form" onsubmit="return false;" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
        <input id="reg-email" type="email" placeholder="you@example.com" required
               style="flex:1;min-width:260px;padding:10px;border:1px solid #ddd;border-radius:8px;">
        <button id="sendRegLink" class="btn" type="button">Send sign-up link</button>
        <a class="btn btn-ghost" href="/login">Already have an account? Log in</a>
      </form>

      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;">
        <a class="btn" href="/auth/oauth/google">Continue with Google</a>
        <a class="btn" href="/auth/oauth/apple">Continue with Apple</a>
      </div>
    </section>
  </main>

  <%- include('partials/footer'); %>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    (function () {
      var url  = (window.__BL_SB && __BL_SB.url)  || '';
      var anon = (window.__BL_SB && __BL_SB.anon) || '';

      if (url && anon && window.supabase && !window.supabaseClient) {
        try {
          window.supabaseClient = window.supabase.createClient(url, anon, {
            auth: { persistSession: true, autoRefreshToken: true }
          });
        } catch (e) {}
      }

      var msg = document.getElementById('msg');
      function show(type, text){
        if (!msg) return;
        msg.style.display = 'block';
        msg.textContent   = text;
        msg.style.background = type === 'ok' ? '#e8f7e8' : '#ffecec';
        msg.style.border     = type === 'ok' ? '1px solid #b7e2b7' : '1px solid #ffcdcd';
        msg.style.color      = '#222';
      }

      var btn = document.getElementById('sendRegLink');
      if (!btn) return;

      btn.addEventListener('click', async function(){
        var email = (document.getElementById('reg-email').value || '').trim();
        if (!email) { show('err','Enter your email first.'); return; }
        if (!window.supabaseClient) { show('err','Auth is not configured on the client. Please try again later.'); return; }

        try {
          var res = await window.supabaseClient.auth.signInWithOtp({
            email: email,
            options: {
              emailRedirectTo: window.location.origin + '/auth/callback',
              shouldCreateUser: true
            }
          });
          if (res && res.error) throw res.error;
          show('ok','✅ The sign-up link has been emailed to you. Please check your inbox.');
        } catch (e) {
          show('err', e && e.message ? e.message : 'Could not send link.');
        }
      });
    })();
  </script>
</body>
</html>
