<!doctype html>
<html lang="en">
<head>
  <%- include('./partials/head', {
    pageTitle: 'Create Account â€¢ BookLantern',
    pageDescription: 'Create a free account to sync bookmarks and notes.',
    canonicalUrl: (typeof canonicalUrl !== 'undefined' ? canonicalUrl : '')
  }) %>
</head>
<body>
  <%- include('./partials/navbar') %>

  <main class="container" style="max-width:700px; margin:28px auto; padding:0 16px;">
    <h1>Create account</h1>
    <p class="ink-2">Weâ€™ll email a confirmation link.</p>

    <!-- status banner (success/info/errors) -->
    <div id="banner" class="card" style="display:none; padding:10px; margin:12px 0;"></div>

    <form id="regForm" class="card" style="padding:16px; margin-top:12px;" novalidate>
      <div class="stack" style="--gap:10px;">
        <input class="input" type="email" id="email" placeholder="you@example.com" autocomplete="email" required>
        <input class="input" type="password" id="password" placeholder="Create a password (min 8 chars)" autocomplete="new-password" required>

        <div class="row" style="gap:8px; flex-wrap:wrap;">
          <button class="btn btn-primary" type="submit" id="createBtn">Create account</button>
          <a class="btn" href="/login">Already have an account? Log in</a>
        </div>

        <hr style="border:none; border-top:1px solid rgba(0,0,0,.08); margin:6px 0;">

        <div class="row" style="gap:8px; flex-wrap:wrap;">
          <button class="btn" id="google" type="button">Continue with Google</button>
          <button class="btn" id="apple" type="button">Continue with Apple</button>
        </div>

        <div id="msg" class="ink-2"></div>
      </div>
    </form>
  </main>

  <%- include('./partials/footer') %>

  <script>
  (function(){
    const sb = window.supabaseClient;
    const banner = document.getElementById('banner');
    const msgEl = document.getElementById('msg');
    const createBtn = document.getElementById('createBtn');

    function base(){ return (location.origin || '<%= process.env.SITE_URL || "" %>'); }
    function redirectUrl(){ return base() + '/auth/callback'; }

    function setBanner(text, variant){
      if (!text){ banner.style.display='none'; banner.textContent=''; return; }
      banner.style.display='block';
      banner.textContent = text;
      const ok = variant === 'ok';
      banner.style.background = ok ? 'var(--green-1, #e6f7ed)' : 'var(--ink-1, #f5f5f5)';
      banner.style.border = '1px solid rgba(0,0,0,.08)';
    }
    function setMsg(t){ msgEl.textContent = t || ''; }

    // --- Create account (email+password) ---
    document.getElementById('regForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      setMsg(''); setBanner('');
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;

      if (!email || !password){ setMsg('Enter email and a password (min 8 characters).'); return; }
      if (password.length < 8){ setMsg('Password must be at least 8 characters.'); return; }

      createBtn.disabled = true; const prev = createBtn.textContent; createBtn.textContent = 'Creatingâ€¦';

      try{
        const { data, error } = await sb.auth.signUp({
          email, password,
          options: { emailRedirectTo: redirectUrl() }
        });

        if (error){
          // Common useful messages (rate limit, duplicate user, SMTP failures)
          setMsg(error.message);
          createBtn.disabled = false; createBtn.textContent = prev;
          return;
        }

        // Supabase returns a user object even when email needs confirmation.
        // We stay on the page and show a clear instruction.
        setBanner('ðŸ“¬ Check your inbox and click the verification link to finish creating your account.', 'ok');
        setMsg('');
      }catch(err){
        setMsg(err && err.message ? err.message : 'Something went wrong creating your account.');
      }finally{
        createBtn.disabled = false; createBtn.textContent = prev;
      }
    });

    // --- OAuth quick paths ---
    document.getElementById('google').addEventListener('click', async ()=>{
      await sb.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: redirectUrl() } });
    });
    document.getElementById('apple').addEventListener('click', async ()=>{
      await sb.auth.signInWithOAuth({ provider: 'apple', options: { redirectTo: redirectUrl() } });
    });
  })();
  </script>
</body>
</html>
