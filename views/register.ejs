<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('partials/header'); %>
</head>
<body>
  <%- include('partials/navbar'); %>

  <main class="page-wrap" style="max-width:900px;margin:32px auto 72px;">
    <h1 class="page-title">Create account</h1>

    <section class="card" style="border:1px solid #eee;border-radius:12px;padding:16px;background:#fff;">
      <div id="msg" style="display:none;margin:0 0 12px;padding:10px;border-radius:8px;"></div>

      <p>We'll email you a one-time link to finish creating your account.</p>

      <form id="register-form" class="login-form" onsubmit="return false;" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
        <input id="reg-email" type="email" placeholder="you@example.com" required
               style="flex:1;min-width:260px;padding:10px;border:1px solid #ddd;border-radius:8px;">
        <button id="sendRegLink" class="btn" type="button">Send sign-up link</button>
        <a class="btn btn-ghost" href="/login">Already have an account? Log in</a>
      </form>

      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;">
        <a class="btn" href="/auth/oauth/google">Continue with Google</a>
        <a class="btn" href="/auth/oauth/apple">Continue with Apple</a>
      </div>
    </section>
  </main>

  <%- include('partials/footer'); %>

  <%- include('partials/auth-boot') %>
  <script>
(function () {
  const sb    = window.supabaseClient;
  const input = document.querySelector('#register-email') || document.querySelector('#reg-email') || document.querySelector('input[type="email"]');
  const btn   = document.querySelector('#send-signup')    || document.querySelector('#sendRegLink') || document.querySelector('button[type="submit"]');
  let   err   = document.querySelector('#register-error');
  if (!err) { err = document.createElement('p'); err.id='register-error'; err.style='margin-top:8px;color:#b00020;'; (document.body).appendChild(err); }

  if (!sb) { err.textContent = 'Auth client failed to load.'; return; }

  // PKCE/OAuth auto-handled by detectSessionInUrl; if session exists, send user on.
  sb.auth.getSession().then(({ data, error }) => {
    if (!error && data?.session) window.location.assign("/dashboard");
  });

  if (btn && input) {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      err.textContent='';
      const email=(input.value||'').trim();
      if(!email){ err.textContent='Please enter an email.'; return; }
      const { error } = await sb.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: window.location.origin + '/login?confirmed=1' }
      });
      err.textContent = error ? error.message : 'Sign-up link sent. Check your email.';
    });
  }
})();
  </script>
</body>
</html>
