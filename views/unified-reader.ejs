<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('./partials/head.ejs', {
    pageTitle: (typeof pageTitle !== 'undefined' && pageTitle) ? pageTitle : (gid ? `Gutenberg #${gid} | Reader` : 'Reader'),
    pageDescription: (typeof pageDescription !== 'undefined' && pageDescription) ? pageDescription : 'Read this title in BookLantern’s unified reader.'
  }) %>
  <style>
    :root { --barH:56px; --statusH:44px; --bg:#0b0d10; --ink:#e6edf3; --muted:#98a2b3; --card:#11161d; --line:#1f2937; --brand:#6c8cff; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}

    /* Top bar */
    .bar{display:flex;align-items:center;gap:12px;height:var(--barH);padding:10px 16px;border-bottom:1px solid var(--line);background:#0e1116}
    .back{color:#cbd5e1;text-decoration:none}
    .title{font-weight:700}
    .badge{font-size:12px;color:#9aa3ad;margin-left:6px}
    .grow{flex:1}
    .btn{padding:6px 10px;border-radius:10px;border:1px solid #2a3340;background:var(--card);color:var(--ink);text-decoration:none;cursor:pointer}
    .btn:hover{filter:brightness(1.05)}

    /* Status bar */
    .status{
      height:var(--statusH);
      display:flex;align-items:center;
      gap:10px;padding:8px 16px;border-bottom:1px solid #1e232b;background:#0f1319;
      color:var(--muted);font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .status.hidden{display:none}

    /* Reading area */
    iframe{display:block;width:100%;height:calc(100vh - var(--barH) - var(--statusH));border:0;background:#fff}

    /* Guest screen */
    .guest-wrap{min-height:100vh;display:flex;flex-direction:column}
    .guest-card{max-width:520px;margin:8vh auto;padding:20px;border:1px solid #263041;border-radius:14px;background:#0f1319;color:var(--ink);box-shadow:0 20px 60px rgba(0,0,0,.35)}
    .guest-card h1{margin:0 0 8px 0;font-size:22px}
    .guest-card p{margin:0 0 14px 0;color:var(--muted)}
    .guest-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .cta{padding:8px 12px;border-radius:10px;border:1px solid #263041;background:#172034;color:#e6edf3;text-decoration:none}
    .cta.primary{background:var(--brand);border-color:#425dd6;color:#fff}
    .hint{color:var(--muted);font-size:12px}
  </style>
</head>
<body>

<%
// Build the "next" path so guests come right back after login/register.
const _nextBase = `/read/gutenberg/${encodeURIComponent(gid || '')}/reader`;
const _next = startUrl ? (_nextBase + '?u=' + encodeURIComponent(startUrl)) : _nextBase;
%>

<% if (!user) { %>
  <!-- Friendly guest screen -->
  <div class="guest-wrap">
    <div class="bar">
      <a href="javascript:history.back()" class="back">← Back</a>
      <div class="title">Project Gutenberg</div>
      <% if (gid) { %><span class="badge">#<%= gid %></span><% } %>
      <div class="grow"></div>
    </div>

    <main class="guest-card">
      <h1>Sign in to start reading</h1>
      <p>This Gutenberg title opens inside BookLantern’s reader. Create a free account or sign in to continue.</p>
      <div class="guest-actions">
        <a class="cta primary" href="/register?next=<%= encodeURIComponent(_next) %>">Create account</a>
        <a class="cta" href="/login?next=<%= encodeURIComponent(_next) %>">Login</a>
      </div>
      <p class="hint">Already a member? Use Login. New here? Create an account — it’s quick.</p>
    </main>
  </div>

<% } else { %>

  <!-- Reader chrome (signed-in) -->
  <div class="bar">
    <a href="javascript:history.back()" class="back">← Back</a>
    <div class="title">Project Gutenberg</div>
    <% if (gid) { %><span class="badge">#<%= gid %></span><% } %>
    <div class="grow"></div>
    <% if (startUrl) { %>
      <a class="btn" href="<%= startUrl %>" target="_blank" rel="noopener">Open original ↗</a>
    <% } %>
    <button class="btn" onclick="location.reload()">Reload</button>
  </div>

  <div id="status" class="status">Loading… rendering via BookLantern viewer.</div>

  <iframe id="gFrame"
          src="/read/gutenberg/<%= encodeURIComponent(gid || '') %>/proxy<% if (startUrl) { %>?u=<%= encodeURIComponent(startUrl) %><% } %>"
          allowfullscreen
          referrerpolicy="no-referrer">
  </iframe>

  <script>
    (function(){
      const status = document.getElementById('status');
      const frame  = document.getElementById('gFrame');
      let loaded = false;

      frame.addEventListener('load', function(){
        loaded = true;
        status.classList.add('hidden');
      });

      // Gentle fallback if the upstream is slow
      setTimeout(function(){
        if (!loaded) {
          status.textContent = "Still loading… If it stalls, tap “Open original”.";
        }
      }, 2000);
    })();
  </script>

<% } %>
</body>
</html>
