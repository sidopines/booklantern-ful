<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('./partials/head.ejs', {
    pageTitle: (book && book.title) ? (book.title + ' — Reader') : 'Reader',
    pageDescription: (book && book.description) ? book.description : 'Read in a clean, paginated reader with themes, bookmarks, and audio.'
  }) %>
  <link rel="stylesheet" href="/css/reader.css">
</head>
<body class="reader-body">
  <%- include('./partials/navbar.ejs') %>

  <% /* Guard: this page should only render for logged-in users.
         The route should already protect it, but we keep a friendly fallback. */ %>
  <% if (!user) { %>
    <main class="reader-wrap">
      <div class="guest-wall">
        <h1>Sign in to read</h1>
        <p>You need an account to open this book in the reader.</p>
        <p><a class="btn" href="/login?next=<%= encodeURIComponent(req.originalUrl || '/read') %>">Login</a>
           <a class="btn alt" href="/register">Create free account</a></p>
      </div>
    </main>
  <% } else { %>
  <main class="reader-wrap">
    <!-- Toolbar -->
    <header class="reader-toolbar" role="toolbar" aria-label="Reader controls">
      <a class="btn alt small" href="javascript:history.back()">← Back</a>

      <div class="title">
        <div class="t1"><%= book && book.title ? book.title : 'Untitled' %></div>
        <div class="t2"><%= (book && (book.creator || book.author)) ? (book.creator || book.author) : '' %></div>
      </div>

      <div class="tools">
        <button id="listenBtn" class="tool" title="Listen (Text-to-Speech)" aria-pressed="false">🔊 Listen</button>

        <div class="sep" aria-hidden="true"></div>

        <button id="fontDec" class="tool" title="Smaller text" aria-label="Smaller text">A−</button>
        <button id="fontInc" class="tool" title="Larger text" aria-label="Larger text">A+</button>

        <div class="sep" aria-hidden="true"></div>

        <button id="themeLight" class="tool" title="Light theme" aria-label="Light theme">☀️</button>
        <button id="themeSepia" class="tool" title="Sepia theme" aria-label="Sepia theme">🟨</button>
        <button id="themeDark"  class="tool" title="Dark theme"  aria-label="Dark theme">🌙</button>
      </div>
    </header>

    <!-- Progress -->
    <div class="reader-progress" aria-live="polite">
      <div class="progress-label"><span id="pageNow">1</span> / <span id="pageTotal">1</span></div>
      <div class="progress-bar"><div id="progressFill"></div></div>
    </div>

    <!-- Reader viewport -->
    <section id="reader" class="reader theme-light" tabindex="0" aria-label="Book content">
      <div id="readerContent" class="content">
        <!-- Book HTML will be injected here -->
        <noscript>Please enable JavaScript to read.</noscript>
      </div>

      <!-- Tap/Click zones -->
      <button id="prevPage" class="zone prev" aria-label="Previous page"></button>
      <button id="nextPage" class="zone next" aria-label="Next page"></button>
    </section>
  </main>

  <script>
    // Bootstrap data from server for JS
    window.READER_BOOTSTRAP = {
      gutenbergId: "<%= gutenbergId %>",
      fetchHtmlUrl: "/api/gutenberg/<%= gutenbergId %>/html<%= readerUrl ? ('?u=' + encodeURIComponent(readerUrl)) : '' %>",
      book: {
        id: "<%= book && (book._id || book.identifier || '') %>",
        title: "<%- (book && book.title) ? book.title.replace(/"/g, '&quot;') : '' %>",
        author: "<%- (book && (book.creator || book.author)) ? (book.creator || book.author).replace(/"/g, '&quot;') : '' %>"
      }
    };
  </script>
  <script src="/js/reader.js"></script>
  <script src="/js/tts.js"></script>
  <% } %>
</body>
</html>
