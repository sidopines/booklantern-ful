<!-- views/unified-reader.ejs -->
<% 
  // Safe fallbacks for all variables
  var safeTitle  = (typeof title  === 'string' && title)  ? title  : 'Book';
  var safeAuthor = (typeof author === 'string' && author) ? author : '';
  var safeSource = (typeof source === 'string' && source) ? source : '';
  var safeDirectUrl = (typeof directUrl === 'string' && directUrl) ? directUrl : '';
  var safeBackHref = (typeof backHref === 'string' && backHref) ? backHref : '/read';
  var safeRef = (typeof ref === 'string' && ref) ? ref : '';
  var safeArchiveId = (typeof archiveId === 'string' && archiveId) ? archiveId : '';
  var useEpubJs = (typeof isEpub === 'boolean') ? isEpub : false;
%>
<!doctype html>
<html lang="en">
<head>
  <%- include('./partials/head.ejs', {
    pageTitle: safeTitle + ' • BookLantern',
    pageDescription: 'Reading ' + safeTitle + ' in BookLantern\'s unified reader'
  }) %>
  <link rel="stylesheet" href="/public/css/unified-reader.css?v=<%= buildId || Date.now() %>">
  <% if (useEpubJs) { %>
  <script defer src="/public/vendor/jszip.min.js?v=<%= buildId || Date.now() %>"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/epubjs@0.3.93/dist/epub.min.js"></script>
  <% } %>
</head>
<body data-page="reader" data-epub="<%= useEpubJs %>">
  
  <header class="reader-topbar">
    <a 
      class="reader-back" 
      href="<%= safeBackHref %>"
      data-ref="<%= safeRef %>"
      tabindex="0" 
      aria-label="Go back to previous page"
    >
      <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
      </svg>
      <span>Back</span>
    </a>
    
    <% if (useEpubJs) { %>
    <!-- TOC Toggle Button -->
    <button id="toc-toggle" class="toc-toggle" aria-label="Toggle table of contents" title="Table of Contents">
      <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/>
      </svg>
    </button>
    <% } %>
    
    <div class="reader-title">
      <%= safeTitle %><% if (safeAuthor) { %> — <%= safeAuthor %><% } %>
    </div>
    
    <% if (useEpubJs && safeDirectUrl) { %>
    <!-- Font size controls -->
    <div class="reader-font-controls">
      <button id="font-decrease" aria-label="Decrease font size" title="Smaller text">A-</button>
      <button id="font-increase" aria-label="Increase font size" title="Larger text">A+</button>
    </div>
    
    <!-- Navigation buttons -->
    <div class="reader-nav-buttons">
      <button id="prev-page" aria-label="Previous page" title="Previous page">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
      </button>
      <button id="next-page" aria-label="Next page" title="Next page">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </button>
    </div>
    <% } else if (safeSource) { %>
    <div class="reader-source"><%= safeSource %></div>
    <% } %>
  </header>
  
  <% if (useEpubJs) { %>
  <!-- TOC Panel (slide-in from left) -->
  <div id="toc-overlay" class="toc-overlay"></div>
  <aside id="toc-panel" class="toc-panel" aria-label="Table of Contents">
    <div class="toc-header">
      <h3>Contents</h3>
      <button id="toc-close" class="toc-close" aria-label="Close table of contents">&times;</button>
    </div>
    <ul id="toc-list" class="toc-list">
      <li class="toc-empty">Loading contents...</li>
    </ul>
  </aside>
  <% } %>

  <main class="reader-main">
    <% if (!safeDirectUrl) { %>
      <div class="reader-error">
        <p>Unable to load book content.</p>
        <p>No valid URL provided.</p>
        <button onclick="window.location.href='<%= safeBackHref %>'">Go Back</button>
      </div>
    <% } else if (useEpubJs) { %>
      <!-- ePub.js will render into this div -->
      <div id="epub-viewer" data-epub-url="<%= safeDirectUrl %>" data-archive-id="<%= safeArchiveId %>" data-direct-url="<%= safeDirectUrl %>"></div>
      <div id="epub-loading" class="epub-loading">
        <div class="epub-spinner"></div>
        <p>Loading book...</p>
      </div>
    <% } else { %>
      <iframe
        id="reader-frame"
        src="<%= safeDirectUrl %>"
        title="<%= safeTitle %>"
        loading="lazy"
        referrerpolicy="no-referrer"
        sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox"
        allow="fullscreen"
      ></iframe>
    <% } %>
  </main>

  <script defer src="/public/js/reader.js?v=<%= buildId || Date.now() %>"></script>
  
</body>
</html>
