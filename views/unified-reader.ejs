<!-- views/unified-reader.ejs -->
<% 
  // Safe fallbacks for all variables
  var safeTitle  = (typeof title  === 'string' && title)  ? title  : 'Book';
  var safeAuthor = (typeof author === 'string' && author) ? author : '';
  var safeSource = (typeof source === 'string' && source) ? source : '';
  var safeDirectUrl = (typeof directUrl === 'string' && directUrl) ? directUrl : '';
  var safeSourceUrl = (typeof sourceUrl === 'string' && sourceUrl) ? sourceUrl : safeDirectUrl;
  var safeBackHref = (typeof backHref === 'string' && backHref) ? backHref : '/read';
  var safeRef = (typeof ref === 'string' && ref) ? ref : '';
  var safeArchiveId = (typeof archiveId === 'string' && archiveId) ? archiveId : '';
  var safeBestPdf = (typeof bestPdf === 'string' && bestPdf) ? bestPdf : '';
  var useEpubJs = (typeof isEpub === 'boolean') ? isEpub : false;
  var usePdfViewer = (typeof isPdf === 'boolean') ? isPdf : false;
  var safeFormat = (typeof format === 'string') ? format : 'epub';
  var safeFileSize = (typeof fileSize === 'number') ? fileSize : 0;
  var isTooLarge = (typeof tooLarge === 'boolean') ? tooLarge : false;
  var safeAvailableFiles = (typeof availableFiles === 'object' && availableFiles) ? JSON.stringify(availableFiles) : 'null';
%>
<!doctype html>
<html lang="en">
<head>
  <%- include('./partials/head.ejs', {
    pageTitle: safeTitle + ' • BookLantern',
    pageDescription: 'Reading ' + safeTitle + ' in BookLantern\'s unified reader'
  }) %>
  <link rel="stylesheet" href="/public/css/unified-reader.css?v=<%= buildId || Date.now() %>">
  <% if (useEpubJs) { %>
  <script defer src="/public/vendor/jszip.min.js?v=<%= buildId || Date.now() %>"></script>
  <script defer src="/public/vendor/epub.min.js?v=<%= buildId || Date.now() %>"></script>
  <% } %>
</head>
<body data-page="reader" data-epub="<%= useEpubJs %>" data-pdf="<%= usePdfViewer %>" data-format="<%= safeFormat %>" data-is-admin="<%= (user && user.isAdmin) ? 'true' : 'false' %>" data-show-source-links="<%= process.env.SHOW_SOURCE_LINKS === 'true' ? 'true' : 'false' %>" data-max-epub-mb="<%= process.env.MAX_EPUB_MB || 50 %>" data-max-pdf-mb="<%= process.env.MAX_PDF_MB || 200 %>" data-file-size="<%= safeFileSize %>" data-too-large="<%= isTooLarge %>" data-available-files="<%= safeAvailableFiles %>" data-archive-id="<%= safeArchiveId %>" data-best-pdf="<%= safeBestPdf %>">
  
  <header class="reader-topbar">
    <a 
      class="reader-back" 
      href="<%= safeBackHref %>"
      data-ref="<%= safeRef %>"
      tabindex="0" 
      aria-label="Go back to previous page"
    >
      <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
      </svg>
      <span>Back</span>
    </a>
    
    <% if (useEpubJs) { %>
    <!-- TOC Toggle Button -->
    <button id="toc-toggle" class="toc-toggle" aria-label="Toggle table of contents" title="Table of Contents">
      <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/>
      </svg>
    </button>
    <% } %>
    
    <div class="reader-title">
      <%= safeTitle %><% if (safeAuthor) { %> — <%= safeAuthor %><% } %>
    </div>
    
    <% if (useEpubJs && safeDirectUrl) { %>
    <!-- Font size controls -->
    <div class="reader-font-controls">
      <button id="font-decrease" aria-label="Decrease font size" title="Smaller text">A-</button>
      <button id="font-increase" aria-label="Increase font size" title="Larger text">A+</button>
    </div>
    
    <!-- Navigation buttons -->
    <div class="reader-nav-buttons">
      <button id="prev-page" aria-label="Previous page" title="Previous page">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
      </button>
      <button id="next-page" aria-label="Next page" title="Next page">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </button>
    </div>
    <% } else if (safeSource) { %>
    <div class="reader-source"><%= safeSource %></div>
    <% } %>
  </header>
  
  <% if (useEpubJs) { %>
  <!-- TOC Panel (slide-in from left) -->
  <div id="toc-overlay" class="toc-overlay"></div>
  <aside id="toc-panel" class="toc-panel" aria-label="Table of Contents">
    <div class="toc-header">
      <h3>Contents</h3>
      <button id="toc-close" class="toc-close" aria-label="Close table of contents">&times;</button>
    </div>
    <ul id="toc-list" class="toc-list">
      <li class="toc-empty">Loading contents...</li>
    </ul>
  </aside>
  <% } %>

  <main class="reader-main">
    <% if (!safeDirectUrl && !safeArchiveId) { %>
      <div class="reader-error">
        <p>Unable to load book content.</p>
        <p>No valid URL provided.</p>
        <button onclick="window.location.href='<%= safeBackHref %>'">Go Back</button>
      </div>
    <% } else if (usePdfViewer) { %>
      <!-- PDF viewer via iframe - no sandbox to allow Chrome PDF plugin -->
      <div id="pdf-viewer-container" class="pdf-viewer-container">
        <% 
          // Build PDF proxy URL - use /api/proxy/file for non-archive sources (handles blocked iframes like OpenStax)
          var pdfProxyUrl = safeArchiveId 
            ? '/api/proxy/pdf?archive=' + encodeURIComponent(safeArchiveId)
            : '/api/proxy/file?url=' + encodeURIComponent(safeDirectUrl);
        %>
        <iframe
          id="pdf-frame"
          class="pdf-frame"
          src="<%= pdfProxyUrl %>"
          title="<%= safeTitle %>"
          loading="eager"
          referrerpolicy="no-referrer"
          allow="fullscreen"
        ></iframe>
        <div id="pdf-loading" class="pdf-loading">
          <div class="pdf-spinner"></div>
          <p>Loading PDF...</p>
        </div>
        <!-- Fallback embed for browsers that don't render PDF in iframe -->
        <div id="pdf-fallback" class="pdf-fallback" style="display:none;">
          <p>PDF viewer failed to load.</p>
          <a href="<%= pdfProxyUrl %>" target="_blank" class="pdf-open-btn">Open PDF in new tab</a>
        </div>
      </div>
    <% } else if (useEpubJs) { %>
      <!-- ePub.js will render into this div -->
      <div id="epub-viewer" data-epub-url="<%= safeDirectUrl %>" data-archive-id="<%= safeArchiveId %>" data-direct-url="<%= safeDirectUrl %>" data-source-url="<%= safeSourceUrl %>" data-best-pdf="<%= safeBestPdf %>"></div>
      <div id="epub-loading" class="epub-loading">
        <div class="epub-spinner"></div>
        <p>Loading book...</p>
      </div>
      <% if (isTooLarge) { %>
      <!-- Edition picker for large books -->
      <div id="edition-picker" class="edition-picker" style="display: none;">
        <div class="edition-picker-content">
          <h3>This EPUB is very large</h3>
          <p>The EPUB file is too large to reliably load in the browser. Choose an option:</p>
          <div id="edition-picker-options" class="edition-picker-options"></div>
          <button id="try-anyway-btn" class="edition-picker-btn secondary">Try Loading EPUB Anyway</button>
        </div>
      </div>
      <% } %>
    <% } else { %>
      <iframe
        id="reader-frame"
        src="<%= safeDirectUrl %>"
        title="<%= safeTitle %>"
        loading="lazy"
        referrerpolicy="no-referrer"
        sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox"
        allow="fullscreen"
      ></iframe>
    <% } %>
  </main>

  <script defer src="/public/js/reader.js?v=<%= buildId || Date.now() %>"></script>
  
</body>
</html>
