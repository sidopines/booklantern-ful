<!-- views/unified-reader.ejs -->
<% 
  // Safe fallbacks for all variables
  var safeTitle  = (typeof title  === 'string' && title)  ? title  : 'Book';
  var safeAuthor = (typeof author === 'string' && author) ? author : '';
  var safeSource = (typeof source === 'string' && source) ? source : '';
  var safeDirectUrl = (typeof directUrl === 'string' && directUrl) ? directUrl : '';
  var safeBackHref = (typeof backHref === 'string' && backHref) ? backHref : '/read';
  var safeRef = (typeof ref === 'string' && ref) ? ref : '';
%>
<!doctype html>
<html lang="en">
<head>
  <%- include('./partials/head.ejs', {
    pageTitle: safeTitle + ' • BookLantern',
    pageDescription: 'Reading ' + safeTitle + ' in BookLantern\'s unified reader'
  }) %>
  <link rel="stylesheet" href="/public/css/unified-reader.css?v=<%= buildId || Date.now() %>">
</head>
<body data-page="reader">
  
  <header class="reader-topbar">
    <a 
      class="reader-back" 
      href="<%= safeBackHref %>"
      data-ref="<%= safeRef %>"
      tabindex="0" 
      aria-label="Go back to previous page"
    >
      <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
      </svg>
      Back
    </a>
    <div class="reader-title">
      <%= safeTitle %><% if (safeAuthor) { %> — <%= safeAuthor %><% } %>
    </div>
    <% if (safeSource) { %>
    <div class="reader-source"><%= safeSource %></div>
    <% } %>
  </header>

  <main class="reader-main">
    <% if (safeDirectUrl) { %>
      <iframe
        id="reader-frame"
        src="<%= safeDirectUrl %>"
        title="<%= safeTitle %>"
        loading="lazy"
        referrerpolicy="no-referrer"
        sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox"
        allow="fullscreen"
      ></iframe>
    <% } else { %>
      <div class="reader-error">
        <p>Unable to load book content.</p>
        <p>No valid URL provided.</p>
        <button onclick="window.location.href='<%= safeBackHref %>'">Go Back</button>
      </div>
    <% } %>
  </main>

  <script defer src="/public/js/reader.js?v=<%= buildId || Date.now() %>"></script>
  
</body>
</html>
