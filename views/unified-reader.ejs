<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('./partials/head.ejs', {
    pageTitle: typeof pageTitle !== 'undefined' ? pageTitle : 'Reader',
    pageDescription: typeof pageDescription !== 'undefined' ? pageDescription : 'Read in BookLantern'
  }) %>
  <style>
    :root { --bg:#0b1220; --ink:#0b1220; --muted:#667085; --line:#e5e7eb; --card:#fff; }
    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; height:100%; }
    body { background:#f6f7fb; color:#111; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .wrap { min-height:100vh; display:flex; flex-direction:column; }
    header.reader-bar{
      position: sticky; top:0; z-index:20;
      background:#fff; border-bottom:1px solid var(--line);
    }
    .reader-bar-inner{
      max-width:1100px; margin:0 auto; padding:.6rem 1rem;
      display:flex; align-items:center; justify-content:space-between; gap:.75rem;
    }
    .brand-link{ text-decoration:none; color:#111; font-weight:800; letter-spacing:-.01em; display:flex; align-items:center; gap:.5rem; }
    .brand-link img{ width:20px; height:20px; }
    .controls{ display:flex; gap:.5rem; align-items:center; }
    .btn{ padding:.5rem .7rem; border:1px solid var(--line); background:#fff; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn:hover{ background:#f5f7fb; }
    main{ flex:1 1 auto; display:flex; align-items:stretch; }
    iframe.reader{
      border:0; width:100%; height:calc(100vh - 58px);
      background:#fff;
    }
    .guard{
      max-width:700px; margin:3rem auto; background:#fff; border:1px solid var(--line); border-radius:14px; box-shadow:0 10px 30px rgba(2,6,23,.08);
      padding:1.25rem;
    }
    .guard h1{ margin:.2rem 0 .6rem; font-size:1.4rem; }
    .guard p{ color:#667085; }
    .split{ display:flex; gap:10px; flex-wrap:wrap; margin-top:.6rem; }
    .btn.brand{ background:#111; color:#fff; border-color:#111; }
  </style>
</head>
<body>
  <!-- If user not logged in, show a friendly guard (do not crash) -->
  <% if (!user) { %>
    <%- include('./partials/navbar.ejs') %>
    <main class="container">
      <div class="guard">
        <h1>Sign in to read</h1>
        <p>Create a free account to read in BookLantern’s distraction-free reader.</p>
        <div class="split">
          <a class="btn brand" href="/login?next=<%= encodeURIComponent(req.originalUrl) %>">Login</a>
          <a class="btn" href="/register?next=<%= encodeURIComponent(req.originalUrl) %>">Create account</a>
        </div>
      </div>
    </main>
  <% } else { %>
    <header class="reader-bar">
      <div class="reader-bar-inner">
        <a class="brand-link" href="/">
          <img src="/img/brand.svg" alt="">
          BookLantern
        </a>
        <div class="controls">
          <a class="btn" href="javascript:history.back()">← Back</a>
          <a class="btn" href="/read">All Books</a>
        </div>
      </div>
    </header>

    <main>
      <% 
        const safeUrl = (typeof startUrl === 'string' && startUrl) ? startUrl : (gid ? `https://www.gutenberg.org/ebooks/${gid}` : 'about:blank');
        const _gid = typeof gid !== 'undefined' ? String(gid) : '';
        const proxied = `/read/gutenberg/${encodeURIComponent(_gid)}/proxy?u=${encodeURIComponent(safeUrl)}`;
      %>
      <iframe
        class="reader"
        src="<%= proxied %>"
        referrerpolicy="no-referrer"
        allow="clipboard-read; clipboard-write"
        title="Reader">
      </iframe>
    </main>
  <% } %>
</body>
</html>
