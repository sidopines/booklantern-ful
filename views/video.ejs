<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('partials/header'); %>
  <title><%= (video && video.title) ? video.title : 'Watch' %> • BookLantern</title>
  <style>
    .wrap{max-width:980px;margin:24px auto;padding:0 16px}
    .player{position:relative;width:100%;aspect-ratio:16/9;background:#0a0a0a;border-radius:12px;overflow:hidden;border:1px solid #e5e7eb}
    .player iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
    .back{display:inline-block;margin-bottom:12px}
    .muted{color:#6b7280}
  </style>
</head>
<body>
  <%- include('partials/navbar'); %>
  <main class="wrap">
    <a class="back btn" href="/watch">← Back to Watch</a>

    <h1 style="margin:0 0 6px"><%= (video && video.title) || 'Untitled video' %></h1>
    <div class="muted">by <%= (video && video.channel) || (video && (new URL(video.url)).hostname) || 'Unknown' %></div>

    <section class="player">
      <!-- We set data-url and compute the safe embed URL in JS. -->
      <iframe id="player"
              title="<%= (video && video.title) || 'Video' %>"
              loading="lazy"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              referrerpolicy="strict-origin-when-cross-origin"
              allowfullscreen
              srcdoc="<style>body,html{margin:0;height:100%;display:grid;place-items:center;background:#0a0a0a;color:#9ca3af;font:14px/1.4 system-ui}</style><div>Loading player…</div>">
      </iframe>
    </section>

    <% if (video && video.url) { %>
      <p class="muted" style="margin-top:10px">
        Can’t play? <a href="<%= video.url %>" target="_blank" rel="noopener">Open source</a>.
      </p>
    <% } %>
  </main>
  <%- include('partials/footer'); %>

  <script>
    (function(){
      const raw = <%- JSON.stringify((video && video.url) || '') %>;
      const iframe = document.getElementById('player');

      function pickProvider(u){
        try{
          const url = new URL(u);
          const h = url.hostname.replace(/^www\./,'');
          if (h.includes('youtube.com') || h.includes('youtu.be')) {
            // Extract id from watch?v=, youtu.be/, /shorts/, /embed/, /live/
            let id = url.searchParams.get('v') || '';
            if (!id && url.hostname.includes('youtu.be')) id = url.pathname.split('/')[1] || '';
            if (!id) {
              const m = url.pathname.match(/\/(shorts|embed|live)\/([^/?#]+)/);
              if (m) id = m[2];
            }
            if (!id) return null;
            return { provider:'youtube', embed:`https://www.youtube-nocookie.com/embed/${id}?rel=0&modestbranding=1&iv_load_policy=3` };
          }
          if (h.includes('vimeo.com')) {
            const m = url.pathname.match(/\/(\d+)/);
            if (!m) return null;
            return { provider:'vimeo', embed:`https://player.vimeo.com/video/${m[1]}` };
          }
          // Fallback: try to embed raw (may be blocked)
          return { provider:'raw', embed: u };
        }catch(_e){ return null; }
      }

      const spec = pickProvider(raw);
      if (spec) {
        iframe.removeAttribute('srcdoc');
        iframe.src = spec.embed;
      } else {
        iframe.srcdoc = '<style>body,html{margin:0;height:100%;display:grid;place-items:center;background:#0a0a0a;color:#e11d48;font:14px/1.4 system-ui}</style><div>Unsupported video URL.</div>';
      }
    })();
  </script>
</body>
</html>
