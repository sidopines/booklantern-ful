<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('partials/header'); %>
  <title><%= (locals.video?.title || locals.title || 'Video') %> • BookLantern</title>
  <style>
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .back{display:inline-block;margin:4px 0 12px;padding:8px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;font-weight:600}
    .title{font-weight:800;font-size:32px;line-height:1.1;margin:6px 0 8px}
    .muted{color:#6b7280}
    .player{position:relative;width:100%;aspect-ratio:16/9;background:#0a0a0a;border-radius:12px;overflow:hidden;margin:14px 0 8px}
    .fallback{display:grid;place-items:center;inset:0;position:absolute;color:#6b7280}
    iframe{position:absolute;inset:0;width:100%;height:100%;border:0;display:block}
    .cta{margin-top:12px}
    .cta a{display:inline-block;padding:8px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;font-weight:600}
  </style>
</head>
<body>
  <%- include('partials/navbar'); %>
  <main class="wrap" style="padding-bottom:64px;">
    <a class="back" href="/watch">← Back to Watch</a>

    <% 
      const v = locals.video || locals.v || { 
        title: locals.title, 
        url: locals.url, 
      };
      const raw = String(v?.url || '').trim();

      function ytId(u){
        try{
          const url = new URL(u);
          if (url.hostname.includes('youtu.be')) return url.pathname.split('/')[1] || '';
          if (url.pathname.startsWith('/shorts/')) return url.pathname.split('/')[2] || '';
          const vq = url.searchParams.get('v'); if (vq) return vq;
          const m = url.pathname.match(/\/(embed|live)\/([^/?#]+)/);
          return m ? m[2] : '';
        }catch(_e){ return ''; }
      }

      function vimeoId(u){
        try{
          const url = new URL(u);
          if (!/vimeo\.com$|vimeo\.com$|player\.vimeo\.com$/.test(url.hostname)) return '';
          const parts = url.pathname.split('/').filter(Boolean);
          // /VIDEOID or /channels/.../VIDEOID etc.
          const last = parts[parts.length - 1] || '';
          return /^\d+$/.test(last) ? last : '';
        }catch(_e){ return ''; }
      }

      function toEmbed(u){
        const you = ytId(u);
        if (you) {
          const base = `https://www.youtube-nocookie.com/embed/${you}`;
          // modest branding + disable related + origin for modern YT embedding
          const params = new URLSearchParams({
            rel: '0',
            modestbranding: '1',
            playsinline: '1',
            ref: 'booklantern',
            // origin is recommended; we’ll best-effort it
            origin: `${(typeof req !== 'undefined' ? req.protocol+'://'+req.get('host') : '')}` || ''
          });
          return `${base}?${params.toString()}`;
        }
        const vim = vimeoId(u);
        if (vim) {
          return `https://player.vimeo.com/video/${vim}?byline=0&portrait=0&title=0`;
        }
        // Generic: if it already looks like an embeddable URL, allow it; else return empty
        try {
          const url = new URL(u);
          if (/\/embed\//.test(url.pathname)) return url.toString();
        } catch (_e){}
        return '';
      }

      const embedUrl = toEmbed(raw);
      const title = v?.title || 'Video';
      const channel = v?.channel || (raw ? new URL(raw).hostname.replace(/^www\./,'') : '');
    %>

    <h1 class="title"><%= title %></h1>
    <% if (channel) { %><div class="muted">by <%= channel %></div><% } %>

    <section class="player" role="region" aria-label="Video player">
      <% if (embedUrl) { %>
        <iframe
          src="<%= embedUrl %>"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen
          referrerpolicy="strict-origin-when-cross-origin"
          loading="eager">
        </iframe>
      <% } else { %>
        <div class="fallback">
          <div>
            <p>Can’t embed this link safely.</p>
            <% if (raw) { %>
              <p class="cta"><a href="<%= raw %>" target="_blank" rel="noopener">Open on source site</a></p>
            <% } %>
          </div>
        </div>
      <% } %>
    </section>

    <% if (raw && embedUrl) { %>
      <div class="cta">
        <a href="<%= raw %>" target="_blank" rel="noopener">Open on source site</a>
      </div>
    <% } %>
  </main>
  <%- include('partials/footer'); %>
</body>
</html>
